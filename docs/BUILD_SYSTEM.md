# Build System Documentation

## Overview

The WOS Calculator project now includes an automated build pipeline that minifies assets, generates source maps, and prepares production-ready distributions.

## Quick Start

```bash
# Production build with cache-busting
npm run build

# Development build (no cache-busting)
npm run build:dev

# Start local dev server
npm start

# Run CSS linting
npm run lint
npm run lint:fix
```

## Build Process

The build script (`scripts/build.js`) performs the following operations:

### 1. **CSS Minification**
- Removes comments and unnecessary whitespace
- Collapses repeated properties
- Generates minified `.min.css` files
- **Savings**: Typically 30-40% size reduction

### 2. **JavaScript Minification** (via Terser)
- Dead code elimination
- Variable name mangling (preserves module names)
- Removes `console.log()` (keeps `console.warn/error`)
- Generates source maps for debugging
- **Savings**: Typically 40-60% size reduction

### 3. **Cache Busting**
- Generates MD5 hashes of file contents
- Renames files: `style.css` â†’ `style.a3f9d2b1.min.css`
- Updates HTML references automatically
- Ensures browsers fetch latest versions

### 4. **Asset Management**
- Copies all assets (images, CSV data, icons)
- Preserves directory structure
- Includes manifest.json and service worker

### 5. **Output Structure**

```
dist/
â”œâ”€â”€ index.html
â”œâ”€â”€ charms.html
â”œâ”€â”€ chiefGear.html
â”œâ”€â”€ fireCrystals.html
â”œâ”€â”€ war-academy.html
â”œâ”€â”€ pets.html
â”œâ”€â”€ experts.html
â”œâ”€â”€ manifest.json
â”œâ”€â”€ CNAME
â”œâ”€â”€ netlify.toml
â”œâ”€â”€ Scripts/
â”‚   â”œâ”€â”€ calculator.a1b2c3d4.min.js
â”‚   â”œâ”€â”€ calculator.a1b2c3d4.min.js.map
â”‚   â”œâ”€â”€ profiles.e5f6g7h8.min.js
â”‚   â”œâ”€â”€ profiles.e5f6g7h8.min.js.map
â”‚   â””â”€â”€ ...
â”œâ”€â”€ style/
â”‚   â””â”€â”€ style.i9j0k1l2.min.css
â””â”€â”€ assets/
    â”œâ”€â”€ resource_data.xlsx
    â”œâ”€â”€ *.csv
    â””â”€â”€ resources/
        â”œâ”€â”€ base/
        â”œâ”€â”€ charms/
        â”œâ”€â”€ chief-gear/
        â””â”€â”€ ...
```

## Configuration

Edit `scripts/build.js` to customize:

```javascript
const CONFIG = {
  sourceDir: path.join(__dirname, '..', 'src'),
  distDir: path.join(__dirname, '..', 'dist'),
  generateSourceMaps: true,  // Set false to skip .map files
  cacheBusting: true,         // Set false to keep original filenames
  verbose: true               // Set false for quiet builds
};
```

## Module Name Preservation

The build system preserves these module names for compatibility:

- `CalculatorModule`
- `ProfilesModule`
- `ThemeModule`
- `TableSortModule`
- `DataLoader`
- `I18n`
- `IconHelper`

These are **not mangled** during minification to maintain cross-file module references.

## Source Maps

Source maps are generated by default for JavaScript files:

```
calculator.min.js
calculator.min.js.map  â† Points to original source
```

**Usage in DevTools**:
1. Open browser DevTools (F12)
2. Navigate to Sources tab
3. Original source code appears with proper formatting
4. Set breakpoints in original code

## Deployment

### Netlify (Automated)

The build output (`dist/`) is optimized for Netlify deployment:

```bash
# Push to main branch triggers build
git add -A
git commit -m "feat: add build pipeline"
git push origin main
```

Netlify configuration (in `netlify.toml`):

```toml
[build]
  publish = "dist"
  command = "npm run build"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
```

### Manual Deployment

```bash
# Build for production
npm run build

# Upload dist/ folder to hosting provider
# Example: GitHub Pages, Vercel, Cloudflare Pages, etc.
```

## Performance Gains

| Asset Type | Original | Minified | Savings |
|------------|----------|----------|---------|
| CSS        | ~247 KB  | ~150 KB  | ~39%    |
| JavaScript | ~450 KB  | ~200 KB  | ~56%    |
| **Total**  | **~697 KB** | **~350 KB** | **~50%** |

**Expected Impact**:
- ğŸš€ Faster initial page load (50% smaller payload)
- âš¡ Reduced bandwidth usage
- ğŸ“± Better mobile experience (less data transfer)
- ğŸ’¾ Improved cache efficiency (hash-based versioning)

## Troubleshooting

### Build Fails on JavaScript Minification

If a specific JS file causes Terser to fail, the build script falls back to copying the original file. Check console output:

```
âœ— Failed to minify theme.js: Unexpected token...
â†’ Copied original file instead
```

**Solution**: Fix syntax errors in the source file.

### Source Maps Not Working

Ensure `generateSourceMaps: true` in build config and your browser DevTools has source maps enabled:

- Chrome: DevTools â†’ Settings â†’ Enable JavaScript source maps
- Firefox: DevTools â†’ Settings â†’ Enable Source Maps

### Cache Busting Not Updating

If browsers still load old assets:

1. Check HTML references were updated: `style.OLDHASH.min.css` â†’ `style.NEWHASH.min.css`
2. Clear browser cache (Ctrl+Shift+Delete)
3. Use hard reload (Ctrl+F5)

## Development Workflow

```bash
# During development - work in src/
cd src
python -m http.server 8080

# Edit files in src/Scripts, src/style, src/*.html
# Test locally at http://127.0.0.1:8080

# Before deploying
npm run build

# Verify build output
cd dist
python -m http.server 8081
# Test at http://127.0.0.1:8081

# Deploy when satisfied
git add dist/
git commit -m "build: production release"
git push
```

## Future Enhancements

Planned improvements:

- [ ] **Tree-shaking**: Remove unused functions from bundles
- [ ] **Code splitting**: Load calculator modules on-demand
- [ ] **Image optimization**: Compress PNG/JPEG assets
- [ ] **Critical CSS inlining**: Inline above-the-fold styles
- [ ] **Brotli compression**: Pre-compress assets for faster transfer
- [ ] **Service worker caching**: Automatic asset precaching

## Related Documentation

- [Project Structure](../docs/PROJECT_STRUCTURE.md)
- [CSS Breakpoints Audit](../docs/CSS_BREAKPOINTS_AUDIT.md)
- [Maintenance Guide](../docs/MAINTENANCE.md)
