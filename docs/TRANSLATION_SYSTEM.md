# Translation System Documentation

## Overview

The WOS Calculator uses a **dual translation system** to handle both static HTML content and dynamically generated JavaScript content. This document covers the complete translation architecture, usage patterns, and best practices.

---

## Table of Contents

1. [Architecture](#architecture)
2. [System 1: Static HTML Translation](#system-1-static-html-translation)
3. [System 2: Dynamic JavaScript Translation](#system-2-dynamic-javascript-translation)
4. [Enhanced Features](#enhanced-features)
5. [API Reference](#api-reference)
6. [Usage Examples](#usage-examples)
7. [Adding New Translations](#adding-new-translations)
8. [Troubleshooting](#troubleshooting)

---

## Architecture

### Translation Flow

```
User loads page
    ‚Üì
DOMContentLoaded event fires
    ‚Üì
translations.js initializes
    ‚Üì
validateTranslations() runs (checks for missing keys)
    ‚Üì
Retrieves saved language from localStorage
    ‚Üì
applyTranslations(lang) updates [data-i18n] elements ‚Üê SYSTEM 1
    ‚Üì
User interacts with calculator
    ‚Üì
JavaScript generates results using t(key, options) ‚Üê SYSTEM 2
    ‚Üì
Results display with translated content
```

### Supported Languages

- üá¨üáß **English (en)** - Base language
- üá™üá∏ **Spanish (es)** - Espa√±ol
- üá∞üá∑ **Korean (ko)** - ÌïúÍµ≠Ïñ¥
- üá∑üá∫ **Russian (ru)** - –†—É—Å—Å–∫–∏–π
- üá´üá∑ **French (fr)** - Fran√ßais
- üá©üá™ **German (de)** - Deutsch
- üáµüáπ **Portuguese (pt)** - Portugu√™s
- üáÆüáπ **Italian (it)** - Italiano

---

## System 1: Static HTML Translation

### How It Works

Static HTML elements are translated using the `data-i18n` attribute. When the page loads or language changes, the system finds all elements with this attribute and replaces their `textContent` with the translated value.

### HTML Usage

```html
<!-- Basic translation -->
<h3 data-i18n="profiles-header">Profiles</h3>

<!-- Button text -->
<button data-i18n="delete">Delete</button>

<!-- Navigation links -->
<a href="charms.html" data-i18n="nav-charms">Charms</a>

<!-- Labels -->
<label data-i18n="from" for="helmet-start">FROM:</label>

<!-- Placeholder translation (special attribute) -->
<input type="text" data-i18n-placeholder="profile-name-placeholder">
```

### When to Use System 1

‚úÖ **Use for:**
- Navigation links
- Page headings
- Form labels
- Button text
- Static section titles
- Any HTML element that exists on page load

‚ùå **Don't use for:**
- Dynamically generated content
- Content created by JavaScript
- Results tables
- Calculated values

---

## System 2: Dynamic JavaScript Translation

### How It Works

JavaScript code uses the `t()` function to translate strings when generating HTML dynamically. This is essential for results tables, error messages, and any content created at runtime.

### Basic Usage

```javascript
// Simple translation
const text = t('total-power');  // Uses current language

// Explicit language
const text = t('total-power', { lang: 'es' });  // Force Spanish

// Backward compatible (legacy syntax)
const text = t('total-power', 'es');  // Also works
```

### When to Use System 2

‚úÖ **Use for:**
- Results tables generated by calculators
- Dynamically created HTML strings
- Error messages in JavaScript
- Calculated summaries
- Building names in results

‚ùå **Don't use for:**
- Static HTML elements
- Navigation (use data-i18n)
- Form labels (use data-i18n)

---

## Enhanced Features

### 1. Variable Interpolation

Insert dynamic values into translated strings using `{{variableName}}` syntax.

**Translation Definition:**
```javascript
en: {
    "welcome-message": "Welcome {{name}}, you have {{count}} items!"
}
```

**JavaScript Usage:**
```javascript
const message = t('welcome-message', {
    vars: {
        name: 'John',
        count: 5
    }
});
// Result: "Welcome John, you have 5 items!"
```

**HTML Example:**
```javascript
html += `<div>${t('player-stats', { 
    vars: { 
        level: playerLevel, 
        power: totalPower 
    }
})}</div>`;
```

### 2. Pluralization Support

Handle singular/plural forms based on count.

**Translation Definition:**
```javascript
en: {
    "items-count": {
        "zero": "No items",
        "one": "1 item",
        "other": "%d items"
    }
}
```

**JavaScript Usage:**
```javascript
t('items-count', { count: 0 });   // "No items"
t('items-count', { count: 1 });   // "1 item"
t('items-count', { count: 5 });   // "5 items"
```

### 3. Context-Aware Translations

Use the same key for different contexts.

**Translation Definition:**
```javascript
en: {
    "close": {
        "button": "Close",
        "proximity": "Nearby",
        "relationship": "Close friend"
    }
}
```

**JavaScript Usage:**
```javascript
t('close', { context: 'button' });      // "Close"
t('close', { context: 'proximity' });   // "Nearby"
```

### 4. Missing Translation Tracking

The system automatically tracks missing translations for development purposes.

**Check Missing Translations:**
```javascript
// In browser console
const missing = window.I18n.getMissingTranslations();
console.log('Missing:', missing);
// Output: ["es:new-feature", "ko:new-feature", ...]
```

**Clear Tracker:**
```javascript
window.I18n.clearMissingTranslations();
```

### 5. Translation Statistics

Get insights into your translation coverage.

**Get Statistics:**
```javascript
const stats = window.I18n.getTranslationStats();
console.log(stats);
// Output:
// {
//   languages: 8,
//   languageList: ["en", "es", "ko", "ru", "fr", "de", "pt", "it"],
//   totalKeys: 245,
//   missingCount: 3,
//   currentLanguage: "en"
// }
```

### 6. Enhanced Validation

Automatic validation runs on initialization to detect issues.

**Manual Validation:**
```javascript
window.I18n.validateTranslations();
// Checks for:
// - Invalid characters (ÔøΩ)
// - Missing keys in non-English languages
// - Inconsistent translation structure
```

**Console Output:**
```
[I18n] Validation complete
  languages: 8
  totalKeys: 245
  invalidChars: 0
  missingInLanguages: 2
[I18n] Missing translation keys detected:
  es: 3 missing keys ["new-feature", "beta-label", "advanced-settings"]
  ko: 5 missing keys ["new-feature", "beta-label", ...]
```

---

## API Reference

### Global Object: `window.I18n`

All translation functions are exposed through the global `window.I18n` object.

#### `t(key, options)`

Main translation function with enhanced features.

**Parameters:**
- `key` (string): Translation key (supports dot notation)
- `options` (Object|string): Options object or language string (backward compatible)
  - `options.lang` (string): Language code (default: current language)
  - `options.vars` (Object): Variables for interpolation
  - `options.count` (number): Count for pluralization
  - `options.context` (string): Context for context-aware translations

**Returns:** `string` - Translated text

**Examples:**
```javascript
// Simple
t('total-power')

// With language
t('total-power', { lang: 'es' })

// With variables
t('greeting', { vars: { name: 'John' } })

// With count (pluralization)
t('items', { count: 5 })

// Combined
t('purchase-summary', { 
    vars: { item: 'Sword' }, 
    count: 3,
    lang: 'fr'
})

// Backward compatible
t('total-power', 'es')  // Still works
```

#### `getCurrentLanguage()`

Get the currently active language.

**Returns:** `string` - Language code (e.g., 'en', 'es')

**Example:**
```javascript
const lang = window.I18n.getCurrentLanguage();
console.log('Current language:', lang);  // "en"
```

#### `applyTranslations(lang)`

Apply translations to all `[data-i18n]` elements.

**Parameters:**
- `lang` (string): Language code

**Example:**
```javascript
window.I18n.applyTranslations('es');  // Switch to Spanish
```

#### `getMissingTranslations()`

Get array of missing translation keys (for development).

**Returns:** `Array<string>` - Missing keys in format "lang:key"

**Example:**
```javascript
const missing = window.I18n.getMissingTranslations();
console.log(missing);
// ["es:new-feature", "ko:new-feature", "ru:beta-label"]
```

#### `getTranslationStats()`

Get statistics about translations.

**Returns:** `Object` - Statistics object

**Example:**
```javascript
const stats = window.I18n.getTranslationStats();
console.log(stats);
// {
//   languages: 8,
//   languageList: ["en", "es", "ko", "ru", "fr", "de", "pt", "it"],
//   totalKeys: 245,
//   missingCount: 3,
//   currentLanguage: "en"
// }
```

#### `clearMissingTranslations()`

Clear the missing translations tracker.

**Example:**
```javascript
window.I18n.clearMissingTranslations();
```

#### `validateTranslations()`

Manually run translation validation.

**Example:**
```javascript
window.I18n.validateTranslations();
// Outputs warnings to console if issues found
```

---

## Usage Examples

### Example 1: Results Table with Building Names

```javascript
// In fire-crystals-calculator.js
function renderResults(buildingResults) {
    const lang = window.I18n.getCurrentLanguage();
    const t = window.I18n.t;
    
    const rows = Object.entries(buildingResults).map(([building, costs]) => {
        return `<tr>
            <td>${t(building, { lang })}</td>
            <td>${costs.from || ''}</td>
            <td>${costs.to || ''}</td>
            <td>${formatNumber(costs.normalFC)}</td>
        </tr>`;
    }).join('');
    
    return `
        <table class="results-table">
            <thead>
                <tr>
                    <th>${t('building', { lang })}</th>
                    <th>${t('from', { lang })}</th>
                    <th>${t('to', { lang })}</th>
                    <th>${t('fire-crystals', { lang })}</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
}
```

### Example 2: Gap Messages with Variables

```javascript
// Calculate resource gap
const meatGap = totalMeat - inventoryMeat;

// Generate localized message
const gapMessage = meatGap > 0 
    ? t('gap-need-more', { 
        vars: { amount: formatNumber(meatGap) },
        lang
      })
    : t('gap-have-left', { 
        vars: { amount: formatNumber(Math.abs(meatGap)) },
        lang
      });

html += `<div class="gap ${meatGap > 0 ? 'deficit' : 'surplus'}">${gapMessage}</div>`;
```

### Example 3: Dynamic Summary with Pluralization

```javascript
// Translation definition
en: {
    "upgrades-summary": {
        "zero": "No upgrades selected",
        "one": "1 upgrade selected",
        "other": "{{count}} upgrades selected"
    }
}

// Usage
const upgradeCount = selectedUpgrades.length;
const summary = t('upgrades-summary', { 
    count: upgradeCount,
    vars: { count: upgradeCount }
});

document.getElementById('summary').textContent = summary;
```

### Example 4: Debugging Missing Translations

```javascript
// Run after navigating the app
function checkTranslations() {
    const missing = window.I18n.getMissingTranslations();
    
    if (missing.length > 0) {
        console.warn('Found missing translations:', missing.length);
        
        // Group by language
        const byLang = {};
        missing.forEach(item => {
            const [lang, key] = item.split(':');
            if (!byLang[lang]) byLang[lang] = [];
            byLang[lang].push(key);
        });
        
        console.table(byLang);
    } else {
        console.log('‚úÖ All translations found!');
    }
}

// Run in console after using all features
checkTranslations();
```

---

## Adding New Translations

### Step 1: Add to English (Base Language)

```javascript
// In translations.js
en: {
    // ... existing translations
    
    // Add your new key
    "new-feature-title": "Advanced Analytics",
    "new-feature-desc": "View detailed statistics for your upgrades",
    
    // With pluralization
    "items-found": {
        "zero": "No items found",
        "one": "Found 1 item",
        "other": "Found %d items"
    }
}
```

### Step 2: Add to All Other Languages

```javascript
es: {
    "new-feature-title": "An√°lisis Avanzado",
    "new-feature-desc": "Ver estad√≠sticas detalladas de tus mejoras",
    "items-found": {
        "zero": "No se encontraron elementos",
        "one": "Se encontr√≥ 1 elemento",
        "other": "Se encontraron %d elementos"
    }
}

// Repeat for: ko, ru, fr, de, pt, it
```

### Step 3: Use in HTML or JavaScript

**HTML:**
```html
<h3 data-i18n="new-feature-title">Advanced Analytics</h3>
<p data-i18n="new-feature-desc">View detailed statistics</p>
```

**JavaScript:**
```javascript
const title = t('new-feature-title');
const count = t('items-found', { count: items.length });
```

### Step 4: Validate

```javascript
// In browser console
window.I18n.validateTranslations();

// Check for missing
const missing = window.I18n.getMissingTranslations();
if (missing.length > 0) {
    console.warn('Still missing:', missing);
}
```

---

## Best Practices

### ‚úÖ DO:

1. **Use descriptive keys**
   ```javascript
   // Good
   "profile-save-success": "Profile saved successfully"
   
   // Bad
   "msg1": "Profile saved successfully"
   ```

2. **Keep keys consistent across languages**
   ```javascript
   // All languages should have the same keys
   en: { "total-power": "Total Power" }
   es: { "total-power": "Poder Total" }
   ```

3. **Use data-i18n for static HTML**
   ```html
   <!-- Good -->
   <h3 data-i18n="results">Results</h3>
   
   <!-- Bad - using JavaScript for static content -->
   <h3 id="results"></h3>
   <script>document.getElementById('results').textContent = t('results');</script>
   ```

4. **Use t() for dynamic content**
   ```javascript
   // Good
   html += `<td>${t(buildingName)}</td>`;
   
   // Bad - hardcoding
   html += `<td>Furnace</td>`;
   ```

5. **Test with multiple languages**
   ```javascript
   // Switch languages and verify layout doesn't break
   ['en', 'es', 'ko', 'ru'].forEach(lang => {
       window.I18n.applyTranslations(lang);
       // Check UI
   });
   ```

### ‚ùå DON'T:

1. **Don't hardcode text in HTML for dynamic content**
   ```html
   <!-- Bad -->
   <span>Total Power: <span id="power-value"></span></span>
   
   <!-- Good -->
   <span><span data-i18n="total-power">Total Power</span>: <span id="power-value"></span></span>
   ```

2. **Don't mix translation systems**
   ```javascript
   // Bad - using t() on page load for static content
   document.getElementById('title').textContent = t('title');
   
   // Good - use data-i18n
   // <h1 id="title" data-i18n="title">Title</h1>
   ```

3. **Don't skip validation**
   ```javascript
   // Always validate after adding translations
   window.I18n.validateTranslations();
   ```

4. **Don't use abbreviations for keys**
   ```javascript
   // Bad
   "tp": "Total Power"
   
   // Good
   "total-power": "Total Power"
   ```

---

## Troubleshooting

### Issue: Translation not appearing

**Symptoms:** Text shows translation key instead of translated value

**Solutions:**
1. Check if key exists in translations dictionary
   ```javascript
   console.log(window.I18n.translations.en['your-key']);
   ```

2. Verify language is loaded
   ```javascript
   console.log(window.I18n.getCurrentLanguage());
   ```

3. Check for typos in key name
   ```javascript
   // Check all keys
   console.log(Object.keys(window.I18n.translations.en));
   ```

### Issue: Language not changing

**Symptoms:** UI stays in same language after selection

**Solutions:**
1. Check if language selector event is firing
   ```javascript
   document.getElementById('language-selector').addEventListener('change', (e) => {
       console.log('Language changed to:', e.target.value);
   });
   ```

2. Verify localStorage is working
   ```javascript
   localStorage.setItem('test', '1');
   console.log(localStorage.getItem('test'));  // Should log '1'
   ```

3. Check browser console for errors
   ```javascript
   // Look for [I18n] messages
   ```

### Issue: Missing translations in specific language

**Symptoms:** Some text appears in English when other language selected

**Solutions:**
1. Run validation to find missing keys
   ```javascript
   window.I18n.validateTranslations();
   ```

2. Check missing translations tracker
   ```javascript
   const missing = window.I18n.getMissingTranslations();
   console.log('Missing:', missing.filter(m => m.startsWith('es:')));
   ```

3. Add missing translations to target language

### Issue: Variables not interpolating

**Symptoms:** {{variableName}} appears literally in text

**Solutions:**
1. Check if using correct syntax
   ```javascript
   // Correct
   t('message', { vars: { name: 'John' } })
   
   // Incorrect
   t('message', { name: 'John' })  // Wrong - must use 'vars' key
   ```

2. Verify translation definition uses double curly braces
   ```javascript
   // Correct
   "message": "Hello {{name}}"
   
   // Incorrect
   "message": "Hello {name}"
   ```

---

## Performance Considerations

### Translation Caching

The system caches translations in memory. Language files are loaded once on page load.

### Optimization Tips

1. **Minimize dynamic translations in loops**
   ```javascript
   // Bad - translates on every iteration
   results.forEach(r => {
       html += `<td>${t('building')}</td>`;
   });
   
   // Good - translate once
   const buildingLabel = t('building');
   results.forEach(r => {
       html += `<td>${buildingLabel}</td>`;
   });
   ```

2. **Batch DOM updates**
   ```javascript
   // Build complete HTML string, then update DOM once
   let html = '';
   results.forEach(r => {
       html += renderRow(r);
   });
   container.innerHTML = html;  // Single DOM update
   ```

3. **Use static translations when possible**
   ```html
   <!-- Faster - no JavaScript needed -->
   <h3 data-i18n="results">Results</h3>
   
   <!-- Slower - requires JavaScript execution -->
   <h3 id="results"></h3>
   <script>document.getElementById('results').textContent = t('results');</script>
   ```

---

## Future Enhancements

### Planned Features

1. **Lazy Loading** - Load language files on demand
2. **RTL Support** - Right-to-left language support (Arabic, Hebrew)
3. **Date/Time Localization** - Using Intl.DateTimeFormat
4. **Number Formatting** - Enhanced Intl.NumberFormat integration
5. **Translation Memory** - Reuse translations across projects

### Contributing

To contribute translations or report issues:
1. Open issue on GitHub with missing translations
2. Submit PR with new language support
3. Report translation errors or typos

---

## Version History

### v2.0.0 (Current)
- ‚ú® Enhanced t() function with variable interpolation
- ‚ú® Pluralization support
- ‚ú® Context-aware translations
- ‚ú® Missing translation tracking
- ‚ú® Translation statistics API
- ‚ú® Improved validation system

### v1.0.0
- ‚úÖ Basic static HTML translation (data-i18n)
- ‚úÖ Dynamic JavaScript translation (t() function)
- ‚úÖ 8 language support
- ‚úÖ LocalStorage persistence

---

## Contact & Support

For translation issues or questions:
- Check console for [I18n] debug messages
- Use `window.I18n.validateTranslations()` to diagnose
- Report issues with missing translations

---

*Last updated: December 3, 2025*
