const ProfilesModule=function(){const e="wos-unified-profiles",t="wos-last-profile",n="wos-shared-base-resources";let a=null;const r="wos-storage-consent",o="wos-storage-consent-declined-session",c=[["inventory-meat"],["inventory-wood"],["inventory-coal"],["inventory-iron"],["inventory-fire-crystals","inventory-fc"],["inventory-refine-crystals"]],l="data-profile-key",i={fireCrystals:()=>!!document.getElementById("furnace-start"),chiefGear:()=>!!document.getElementById("helmet-start"),charms:()=>!!document.querySelector('select[id*="-charm-"]'),warLab:()=>!!document.querySelector(".war-lab-page")&&!!window.WarLabProfile};function s(){return Object.fromEntries(Object.entries(i).map(([e,t])=>[e,!!t()]))}function d(){const e={};c.forEach(t=>{const n=t[0];for(const a of t){const t=document.getElementById(a);if(t&&void 0!==t.value){e[n]=t.value;break}}});try{localStorage.setItem(n,JSON.stringify(e))}catch(e){}}function u(){const e=function(){try{const e=localStorage.getItem(n);if(e)return JSON.parse(e)}catch(e){}return{}}();c.forEach(t=>{const n=t[0],a=e[n];void 0!==a&&t.forEach(e=>{const t=document.getElementById(e);t&&void 0!==t.value&&f(t,a)})})}function f(e,t){if(e){"checkbox"===e.type?e.checked=!!t:e.value=null==t?"":String(t);try{e.dispatchEvent(new Event("input",{bubbles:!0}))}catch(e){}try{e.dispatchEvent(new Event("change",{bubbles:!0}))}catch(e){}}}async function m(){const e=(()=>{if(window.I18n&&"function"==typeof window.I18n.getCurrentLanguage)return window.I18n.getCurrentLanguage();return(navigator.language||navigator.userLanguage||"en").toLowerCase().slice(0,2)})(),t=t=>window.I18n&&"function"==typeof window.I18n.t?window.I18n.t(t,e):t;if(!function(){try{const e="__wos_storage_test__";return localStorage.setItem(e,"1"),localStorage.removeItem(e),!0}catch(e){return!1}}())return console.warn("[Profiles] localStorage unavailable; profiles will not persist."),!1;try{if("granted"===localStorage.getItem(r))return!0}catch(e){}try{if("declined"===sessionStorage.getItem(o))return!1}catch(e){}if(await y({title:t("storage-consent-title"),message:t("storage-consent-body"),confirmText:t("storage-consent-allow"),cancelText:t("storage-consent-deny")})){try{localStorage.setItem(r,"granted")}catch(e){}return!0}try{sessionStorage.setItem(o,"declined")}catch(e){}return!1}function y({title:e="Confirm",message:t="",confirmText:n="Delete",cancelText:a="Cancel",danger:r=!1}={}){return new Promise(o=>{if(document.querySelector(".modal-overlay"))return void o(!1);const c=document.createElement("div");c.className="modal-overlay",c.setAttribute("role","presentation");const l=document.createElement("div");l.className="modal-dialog",l.setAttribute("role","dialog"),l.setAttribute("aria-modal","true"),l.setAttribute("aria-labelledby","modal-title"),l.innerHTML=`\n        <div class="modal-header">\n          <h4 id="modal-title" class="modal-title">${e}</h4>\n        </div>\n        <div class="modal-body">${t}</div>\n        <div class="modal-actions">\n          <button type="button" class="btn secondary" data-action="cancel">${a}</button>\n          <button type="button" class="btn ${r?"danger":"primary"}" data-action="confirm">${n}</button>\n        </div>\n      `,c.appendChild(l),document.body.appendChild(c);const i=l.querySelector('[data-action="cancel"]'),s=l.querySelector('[data-action="confirm"]'),d=e=>{c&&c.parentNode&&c.parentNode.removeChild(c),o(e)};i.addEventListener("click",()=>d(!1)),s.addEventListener("click",()=>d(!0)),c.addEventListener("click",e=>{e.target===c&&d(!1)});document.addEventListener("keydown",e=>{"Escape"===e.key&&(e.preventDefault(),d(!1)),"Enter"===e.key&&(e.preventDefault(),d(!0))},{once:!0}),setTimeout(()=>{s.focus()},0)})}function h(){try{const t=localStorage.getItem(e);if(t)return JSON.parse(t);const n="wos-charm-profiles",a=localStorage.getItem(n);if(a){const e=JSON.parse(a),t={};return Object.keys(e).forEach(n=>{t[n]={charms:e[n],chiefGear:{},inventory:{}}}),g(t),t}return{}}catch(e){return{}}}function g(t){try{localStorage.setItem(e,JSON.stringify(t))}catch(e){}}function p(){const e=s(),t=e.fireCrystals,n=e.chiefGear,a=e.charms,r=e.warLab,o={charms:{},chiefGear:{},inventory:{},fireCrystals:{},warLab:{},meta:{},dynamic:{}};if(a){Array.from(document.querySelectorAll('select[id*="-charm-"][id$="-start"], select[id*="-charm-"][id$="-finish"]')).filter(e=>!e.id.endsWith("-from")&&!e.id.endsWith("-to")).forEach(e=>{e.value&&(o.charms[e.id]=e.value)})}if(n){["helmet","chestplate","ring","watch","pants","staff"].forEach(e=>{const t=document.getElementById(`${e}-start`),n=document.getElementById(`${e}-finish`);t&&t.value&&(o.chiefGear[`${e}-start`]=t.value),n&&n.value&&(o.chiefGear[`${e}-finish`]=n.value)})}if(t){["furnace","embassy","command-center","infirmary","infantry-camp","marksman-camp","lancer-camp","war-academy"].forEach(e=>{const t=document.getElementById(`${e}-start`),n=document.getElementById(`${e}-finish`);t&&t.value&&(o.fireCrystals[`${e}-start`]=t.value),n&&n.value&&(o.fireCrystals[`${e}-finish`]=n.value)})}["inventory-guides","inventory-designs","inventory-secrets","inventory-alloy","inventory-solution","inventory-plans","inventory-amber","inventory-fire-crystals","inventory-refine-crystals","inventory-speedup-days","inventory-construction-speed","inventory-meat","inventory-wood","inventory-coal","inventory-iron"].forEach(e=>{const t=document.getElementById(e);t&&void 0!==t.value&&(o.inventory[e]=t.value)});const c=document.getElementById("zinman-level");if(c&&(o.meta.zinmanLevel=parseInt(c.value,10)||0),r&&window.WarLabProfile&&"function"==typeof window.WarLabProfile.captureState)try{o.warLab=window.WarLabProfile.captureState()}catch(e){console.warn("[Profiles] Failed to capture War Lab state",e)}const i=function(e={}){const t={};return document.querySelectorAll(`[${l}]`).forEach(e=>{const n=e.getAttribute(l);if(!n)return;const a=e.getAttribute("data-profile-scope")||"dynamic",r="checkbox"===e.type?!!e.checked:e.value??"";t[a]||(t[a]={}),t[a][n]=r}),Object.entries(t).forEach(([n,a])=>{e[n]&&(t[n]={...e[n],...a})}),t}({charms:o.charms,chiefGear:o.chiefGear,inventory:o.inventory,fireCrystals:o.fireCrystals,warLab:o.warLab,meta:o.meta,dynamic:o.dynamic});return Object.entries(i).forEach(([e,t])=>{t&&Object.keys(t).length&&(o[e]&&"object"==typeof o[e]||(o[e]={}),o[e]={...o[e],...t})}),o}function v(e){if(!e)return;const t=s(),n=t.fireCrystals,a=t.chiefGear,r=t.charms,o=t.warLab;if(r&&e.charms){Object.keys(e.charms).forEach(t=>{const n=document.getElementById(t);n&&"SELECT"===n.tagName&&f(n,e.charms[t])});if(Array.from(document.querySelectorAll('select[id*="-charm-"][id$="-start"]')).forEach(e=>{const t=e.id.replace(/-start$/,""),n=document.getElementById(t+"-finish");if(n){const t=parseInt(e.value);isNaN(t)||Array.from(n.options).forEach(e=>{const n=parseInt(e.value);e.disabled=!isNaN(n)&&n<t})}}),"undefined"!=typeof CalculatorModule)try{CalculatorModule.calculateAll()}catch(e){}}if(a&&e.chiefGear){Object.keys(e.chiefGear).forEach(t=>{const n=document.getElementById(t);n&&"SELECT"===n.tagName&&f(n,e.chiefGear[t])});if(["helmet","chestplate","ring","watch","pants","staff"].forEach(e=>{const t=document.getElementById(`${e}-start`),n=document.getElementById(`${e}-finish`);t&&n&&"undefined"!=typeof ChiefGearCalculator&&ChiefGearCalculator.validateLevels&&ChiefGearCalculator.validateLevels(t,n)}),"undefined"!=typeof ChiefGearCalculator)try{ChiefGearCalculator.calculateAll()}catch(e){}}if(n&&e.fireCrystals){const t={...e.fireCrystals};if(Object.keys(e.fireCrystals).forEach(n=>{if(n.endsWith("-current")){const a=n.replace(/-current$/,"");t[`${a}-start`]=e.fireCrystals[n]}if(n.endsWith("-desired")){const a=n.replace(/-desired$/,"");t[`${a}-finish`]=e.fireCrystals[n]}}),Object.keys(t).forEach(e=>{const n=document.getElementById(e);n&&"SELECT"===n.tagName&&f(n,t[e])}),"undefined"!=typeof FireCrystalsCalculator)try{const e=["Furnace","Embassy","Command Center","Infirmary","Infantry Camp","Marksman Camp","Lancer Camp","War Academy"];["furnace","embassy","command-center","infirmary","infantry-camp","marksman-camp","lancer-camp","war-academy"].forEach((t,n)=>{const a=document.getElementById(`${t}-start`),r=document.getElementById(`${t}-finish`);if(a&&r&&FireCrystalsCalculator.validateLevels&&FireCrystalsCalculator.getLevelsForBuilding){const t=FireCrystalsCalculator.getLevelsForBuilding(e[n]);FireCrystalsCalculator.validateLevels(a,r,t)}}),FireCrystalsCalculator.calculateAll()}catch(e){}}if(e.inventory&&(Object.keys(e.inventory).forEach(t=>{const n=document.getElementById(t);n&&"INPUT"===n.tagName&&f(n,e.inventory[t])}),d()),e.meta&&void 0!==e.meta.zinmanLevel){const t=document.getElementById("zinman-level");t&&f(t,e.meta.zinmanLevel||0)}if(o&&e.warLab&&window.WarLabProfile&&"function"==typeof window.WarLabProfile.applyState)try{window.WarLabProfile.applyState(e.warLab)}catch(e){console.warn("[Profiles] Failed to apply War Lab state",e)}e.dynamic&&function(e={}){Object.entries(e||{}).forEach(([e,t])=>{t&&"object"==typeof t&&Object.entries(t).forEach(([e,t])=>{const n=document.querySelector(`[${l}="${e}"]`);n&&f(n,t)})})}(e.dynamic)}function E(){const e=document.getElementById("profiles-list");if(!e)return;const t=h();e.innerHTML="",Object.keys(t).forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}function w(e){if(!e)return alert("Enter a profile name");e=String(e).trim().slice(0,10);const n=h();if(n[e])return alert("A profile with that name already exists. Use Overwrite or pick another name.");n[e]=p(),g(n),E();const r=document.getElementById("profiles-list");r&&(r.value=e),a=e;try{localStorage.setItem(t,e)}catch(e){}const o=document.getElementById("profile-name");o&&(o.value="")}function C(){const e=h();if(!a){const e=document.getElementById("profiles-list"),n=e&&e.value,r=(()=>{try{return localStorage.getItem(t)}catch(e){return null}})();a=n||r||null}if(!a){const n=Object.keys(e);if(1!==n.length)return;a=n[0];try{localStorage.setItem(t,a)}catch(e){}}if(!e[a])return;const n=p(),r=e[a];n.charms&&Object.keys(n.charms).length&&(r.charms={...r.charms||{},...n.charms}),n.chiefGear&&Object.keys(n.chiefGear).length&&(r.chiefGear={...r.chiefGear||{},...n.chiefGear}),n.fireCrystals&&Object.keys(n.fireCrystals).length&&(r.fireCrystals={...r.fireCrystals||{},...n.fireCrystals}),n.inventory&&Object.keys(n.inventory).length&&(r.inventory={...r.inventory||{},...n.inventory}),n.warLab&&Object.keys(n.warLab).length&&(r.warLab={...r.warLab||{},...n.warLab}),n.meta&&Object.keys(n.meta).length&&(r.meta={...r.meta||{},...n.meta}),n.dynamic&&Object.keys(n.dynamic).length&&(r.dynamic={...r.dynamic||{},...n.dynamic}),e[a]=r,g(e)}function b(){const e=document.getElementById("profiles-list");if(!e)return alert("No profiles");const n=e.value,r=h();if(!r[n])return alert("Profile not found");a=n;try{localStorage.setItem(t,n)}catch(e){}v(r[n])}function I(){const e=document.getElementById("profiles-list");if(!e)return;const t=e.value;if(!t)return alert("Select a profile to delete");const n=window.I18n&&window.I18n.t?window.I18n.t:e=>e,a=window.I18n&&window.I18n.getCurrentLanguage?window.I18n.getCurrentLanguage():"en",r={es:"<p>¿Seguro que deseas borrar el perfil %s?<br>Esta acción no se puede deshacer.</p>",ru:"<p>Вы уверены, что хотите удалить профиль %s?<br>Это действие нельзя отменить.</p>",ko:"<p>프로필 %s 을(를) 정말 삭제할까요?<br>이 작업은 되돌릴 수 없습니다.</p>"};let o=n("delete-profile-message",a);o&&"delete-profile-message"!==o||(o=r[a]||o);const c="<p>Are you sure you want to delete the profile %s?<br>This action cannot be undone.</p>";"en"!==a&&o===c&&r[a]&&(o=r[a]);const l=o&&"string"==typeof o?o.replace("%s",`<span class="warning">"${t}"</span>`):c.replace("%s",`<span class="warning">"${t}"</span>`);y({title:n("delete-profile-title"),message:l,confirmText:n("delete-profile-confirm"),cancelText:n("delete-profile-cancel"),danger:!0}).then(e=>{if(!e)return;const n=h();delete n[t],g(n),E()})}function L(){const e=document.getElementById("profiles-list"),t=document.getElementById("profile-name");if(!e||!t)return;const n=e.value,a=t.value&&t.value.trim().slice(0,10);if(!n)return alert("Select a profile to rename");if(!a)return alert("Enter the new name in the textbox");const r=h();if(r[a])return alert("A profile with the new name already exists");r[a]=r[n],delete r[n],g(r),E(),t.value=""}return{init:function(){m().then(e=>{if(!e){const e=document.getElementById("profiles-list"),t=document.getElementById("profile-name"),n=document.getElementById("profile-save"),a=document.getElementById("profile-delete"),r=document.getElementById("profile-rename");e&&(e.disabled=!0),t&&(t.disabled=!0),[n,a,r].forEach(e=>{e&&(e.disabled=!0)});const o=document.querySelector(".profiles");if(o){const e=document.createElement("p");e.className="muted",e.textContent="Profile saving is disabled (storage not allowed).",o.appendChild(e)}return}const n=document.getElementById("profile-save"),a=document.getElementById("profile-delete"),r=document.getElementById("profile-rename"),o=document.getElementById("profiles-list"),i=document.getElementById("profile-name");if(n&&n.addEventListener("click",()=>w(i&&i.value&&i.value.trim())),a&&a.addEventListener("click",I),r&&r.addEventListener("click",L),o&&o.addEventListener("change",b),function(){document.querySelectorAll("select[id]:not(#profiles-list):not(#language-selector)").forEach(e=>e.addEventListener("change",C)),document.querySelectorAll('input[id^="inventory-"]').forEach(e=>{c.some(t=>t.includes(e.id))?e.addEventListener("input",()=>{d(),C()}):e.addEventListener("input",C)}),document.querySelectorAll(`[${l}]`).forEach(e=>{const t=()=>{e.id&&SHARED_RESOURCE_IDS.includes(e.id)&&d(),C()};e.addEventListener("input",t),e.addEventListener("change",t)});const e=document.getElementById("zinman-level");e&&e.addEventListener("change",()=>{C();try{FireCrystalsCalculator.calculateAll()}catch(e){}})}(),window.addEventListener("beforeunload",C),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&C()}),u(),E(),o){const e=h(),n=(()=>{try{return localStorage.getItem(t)}catch(e){return null}})(),a=()=>{b(),setTimeout(()=>{window.WOSCalcCore&&"function"==typeof window.WOSCalcCore.runActive?window.WOSCalcCore.runActive():("undefined"!=typeof CalculatorModule&&CalculatorModule.calculateAll&&CalculatorModule.calculateAll(),"undefined"!=typeof ChiefGearCalculator&&ChiefGearCalculator.calculateAll&&ChiefGearCalculator.calculateAll(),"undefined"!=typeof FireCrystalsCalculator&&FireCrystalsCalculator.calculateAll&&FireCrystalsCalculator.calculateAll())},0)};window.FireCrystalsCalculator&&window.FireCrystalsCalculator.init&&document.addEventListener("fc-calculator-ready",a,{once:!0}),window.ChiefGearCalculator&&window.ChiefGearCalculator.init&&document.addEventListener("chief-gear-calculator-ready",a,{once:!0}),window.CalculatorModule&&window.CalculatorModule.init&&document.addEventListener("charms-calculator-ready",a,{once:!0}),setTimeout(()=>{n&&e[n]?(o.value=n,a()):o.options.length>0&&(o.selectedIndex=0,a())},300)}})},readProfiles:h,writeProfiles:g,captureCurrent:p,applyProfileObject:v,renderProfilesList:E,saveNewProfile:w,loadSelectedProfile:b,deleteSelectedProfile:I,renameSelectedProfile:L,autoSaveCurrentProfile:C}}();"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>ProfilesModule.init()):ProfilesModule.init();