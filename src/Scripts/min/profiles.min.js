const ProfilesModule=function(){const e="wos-unified-profiles",t="wos-last-profile";let n=null;const r="wos-storage-consent",a="wos-storage-consent-declined-session";async function l(){const e=window.I18n&&window.I18n.t?window.I18n.t:e=>e;if(!function(){try{const e="__wos_storage_test__";return localStorage.setItem(e,"1"),localStorage.removeItem(e),!0}catch(e){return!1}}())return console.warn("[Profiles] localStorage unavailable; profiles will not persist."),!1;try{if("granted"===localStorage.getItem(r))return!0}catch(e){}try{if("declined"===sessionStorage.getItem(a))return!1}catch(e){}if(await o({title:e("storage-consent-title"),message:e("storage-consent-body"),confirmText:e("storage-consent-allow"),cancelText:e("storage-consent-deny")})){try{localStorage.setItem(r,"granted")}catch(e){}return!0}try{sessionStorage.setItem(a,"declined")}catch(e){}return!1}function o({title:e="Confirm",message:t="",confirmText:n="Delete",cancelText:r="Cancel",danger:a=!1}={}){return new Promise(l=>{if(document.querySelector(".modal-overlay"))return void l(!1);const o=document.createElement("div");o.className="modal-overlay",o.setAttribute("role","presentation");const c=document.createElement("div");c.className="modal-dialog",c.setAttribute("role","dialog"),c.setAttribute("aria-modal","true"),c.setAttribute("aria-labelledby","modal-title"),c.innerHTML=`\n        <div class="modal-header">\n          <h4 id="modal-title" class="modal-title">${e}</h4>\n        </div>\n        <div class="modal-body">${t}</div>\n        <div class="modal-actions">\n          <button type="button" class="btn secondary" data-action="cancel">${r}</button>\n          <button type="button" class="btn ${a?"danger":"primary"}" data-action="confirm">${n}</button>\n        </div>\n      `,o.appendChild(c),document.body.appendChild(o);const i=c.querySelector('[data-action="cancel"]'),s=c.querySelector('[data-action="confirm"]'),d=e=>{o&&o.parentNode&&o.parentNode.removeChild(o),l(e)};i.addEventListener("click",()=>d(!1)),s.addEventListener("click",()=>d(!0)),o.addEventListener("click",e=>{e.target===o&&d(!1)});document.addEventListener("keydown",e=>{"Escape"===e.key&&(e.preventDefault(),d(!1)),"Enter"===e.key&&(e.preventDefault(),d(!0))},{once:!0}),setTimeout(()=>{s.focus()},0)})}function c(){try{const t=localStorage.getItem(e);if(t)return JSON.parse(t);const n="wos-charm-profiles",r=localStorage.getItem(n);if(r){const e=JSON.parse(r),t={};return Object.keys(e).forEach(n=>{t[n]={charms:e[n],chiefGear:{},inventory:{}}}),i(t),t}return{}}catch(e){return{}}}function i(t){try{localStorage.setItem(e,JSON.stringify(t))}catch(e){}}function s(){const e=!!document.getElementById("furnace-start"),t=!!document.getElementById("helmet-start"),n=!!document.querySelector('select[id*="-charm-"]'),r={charms:{},chiefGear:{},inventory:{},fireCrystals:{}};if(n){Array.from(document.querySelectorAll('select[id*="-charm-"][id$="-start"], select[id*="-charm-"][id$="-finish"]')).filter(e=>!e.id.endsWith("-from")&&!e.id.endsWith("-to")).forEach(e=>{e.value&&(r.charms[e.id]=e.value)})}if(t){["helmet","chestplate","ring","watch","pants","staff"].forEach(e=>{const t=document.getElementById(`${e}-start`),n=document.getElementById(`${e}-finish`);t&&t.value&&(r.chiefGear[`${e}-start`]=t.value),n&&n.value&&(r.chiefGear[`${e}-finish`]=n.value)})}if(e){["furnace","embassy","command-center","infirmary","infantry-camp","marksman-camp","lancer-camp","war-academy"].forEach(e=>{const t=document.getElementById(`${e}-start`),n=document.getElementById(`${e}-finish`);t&&t.value&&(r.fireCrystals[`${e}-start`]=t.value),n&&n.value&&(r.fireCrystals[`${e}-finish`]=n.value)})}return["inventory-guides","inventory-designs","inventory-secrets","inventory-alloy","inventory-solution","inventory-plans","inventory-amber","inventory-fire-crystals","inventory-refine-crystals","inventory-speedup-days","inventory-construction-speed","inventory-meat","inventory-wood","inventory-coal","inventory-iron"].forEach(e=>{const t=document.getElementById(e);t&&void 0!==t.value&&(r.inventory[e]=t.value)}),r}function d(e){if(!e)return;const t=!!document.getElementById("furnace-start"),n=!!document.getElementById("helmet-start");if(!!document.querySelector('select[id*="-charm-"]')&&e.charms){Object.keys(e.charms).forEach(t=>{const n=document.getElementById(t);n&&"SELECT"===n.tagName&&(n.value=String(e.charms[t]))});if(Array.from(document.querySelectorAll('select[id*="-charm-"][id$="-start"]')).forEach(e=>{const t=e.id.replace(/-start$/,""),n=document.getElementById(t+"-finish");if(n){const t=parseInt(e.value);isNaN(t)||Array.from(n.options).forEach(e=>{const n=parseInt(e.value);e.disabled=!isNaN(n)&&n<t})}}),"undefined"!=typeof CalculatorModule)try{CalculatorModule.calculateAll()}catch(e){}}if(n&&e.chiefGear){Object.keys(e.chiefGear).forEach(t=>{const n=document.getElementById(t);n&&"SELECT"===n.tagName&&(n.value=String(e.chiefGear[t]))});if(["helmet","chestplate","ring","watch","pants","staff"].forEach(e=>{const t=document.getElementById(`${e}-start`),n=document.getElementById(`${e}-finish`);t&&n&&"undefined"!=typeof ChiefGearCalculator&&ChiefGearCalculator.validateLevels&&ChiefGearCalculator.validateLevels(t,n)}),"undefined"!=typeof ChiefGearCalculator)try{ChiefGearCalculator.calculateAll()}catch(e){}}if(t&&e.fireCrystals){const t={...e.fireCrystals};if(Object.keys(e.fireCrystals).forEach(n=>{if(n.endsWith("-current")){const r=n.replace(/-current$/,"");t[`${r}-start`]=e.fireCrystals[n]}if(n.endsWith("-desired")){const r=n.replace(/-desired$/,"");t[`${r}-finish`]=e.fireCrystals[n]}}),Object.keys(t).forEach(e=>{const n=document.getElementById(e);n&&"SELECT"===n.tagName&&(n.value=String(t[e]))}),"undefined"!=typeof FireCrystalsCalculator)try{const e=["Furnace","Embassy","Command Center","Infirmary","Infantry Camp","Marksman Camp","Lancer Camp","War Academy"];["furnace","embassy","command-center","infirmary","infantry-camp","marksman-camp","lancer-camp","war-academy"].forEach((t,n)=>{const r=document.getElementById(`${t}-start`),a=document.getElementById(`${t}-finish`);if(r&&a&&FireCrystalsCalculator.validateLevels&&FireCrystalsCalculator.getLevelsForBuilding){const t=FireCrystalsCalculator.getLevelsForBuilding(e[n]);FireCrystalsCalculator.validateLevels(r,a,t)}}),FireCrystalsCalculator.calculateAll()}catch(e){}}e.inventory&&Object.keys(e.inventory).forEach(t=>{const n=document.getElementById(t);n&&"INPUT"===n.tagName&&(n.value=String(e.inventory[t]))})}function u(){const e=document.getElementById("profiles-list");if(!e)return;const t=c();e.innerHTML="",Object.keys(t).forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}function f(e){if(!e)return alert("Enter a profile name");e=String(e).trim().slice(0,10);const r=c();if(r[e])return alert("A profile with that name already exists. Use Overwrite or pick another name.");r[e]=s(),i(r),u();const a=document.getElementById("profiles-list");a&&(a.value=e),n=e;try{localStorage.setItem(t,e)}catch(e){}const l=document.getElementById("profile-name");l&&(l.value="")}function m(){const e=c();if(!n){const e=document.getElementById("profiles-list"),r=e&&e.value,a=(()=>{try{return localStorage.getItem(t)}catch(e){return null}})();n=r||a||null}if(!n){const r=Object.keys(e);if(1!==r.length)return;n=r[0];try{localStorage.setItem(t,n)}catch(e){}}if(!e[n])return;const r=s(),a=e[n];r.charms&&Object.keys(r.charms).length&&(a.charms={...a.charms||{},...r.charms}),r.chiefGear&&Object.keys(r.chiefGear).length&&(a.chiefGear={...a.chiefGear||{},...r.chiefGear}),r.fireCrystals&&Object.keys(r.fireCrystals).length&&(a.fireCrystals={...a.fireCrystals||{},...r.fireCrystals}),r.inventory&&Object.keys(r.inventory).length&&(a.inventory={...a.inventory||{},...r.inventory}),e[n]=a,i(e)}function y(){const e=document.getElementById("profiles-list");if(!e)return alert("No profiles");const r=e.value,a=c();if(!a[r])return alert("Profile not found");n=r;try{localStorage.setItem(t,r)}catch(e){}d(a[r])}function h(){const e=document.getElementById("profiles-list");if(!e)return;const t=e.value;if(!t)return alert("Select a profile to delete");const n=window.I18n&&window.I18n.t?window.I18n.t:e=>e,r=window.I18n&&window.I18n.getCurrentLanguage?window.I18n.getCurrentLanguage():"en",a={es:"<p>¿Seguro que deseas borrar el perfil %s?<br>Esta acción no se puede deshacer.</p>",ru:"<p>Вы уверены, что хотите удалить профиль %s?<br>Это действие нельзя отменить.</p>",ko:"<p>프로필 %s 을(를) 정말 삭제할까요?<br>이 작업은 되돌릴 수 없습니다.</p>"};let l=n("delete-profile-message",r);l&&"delete-profile-message"!==l||(l=a[r]||l);const s="<p>Are you sure you want to delete the profile %s?<br>This action cannot be undone.</p>";"en"!==r&&l===s&&a[r]&&(l=a[r]);const d=l&&"string"==typeof l?l.replace("%s",`<span class="warning">"${t}"</span>`):s.replace("%s",`<span class="warning">"${t}"</span>`);o({title:n("delete-profile-title"),message:d,confirmText:n("delete-profile-confirm"),cancelText:n("delete-profile-cancel"),danger:!0}).then(e=>{if(!e)return;const n=c();delete n[t],i(n),u()})}function g(){const e=document.getElementById("profiles-list"),t=document.getElementById("profile-name");if(!e||!t)return;const n=e.value,r=t.value&&t.value.trim().slice(0,10);if(!n)return alert("Select a profile to rename");if(!r)return alert("Enter the new name in the textbox");const a=c();if(a[r])return alert("A profile with the new name already exists");a[r]=a[n],delete a[n],i(a),u(),t.value=""}return{init:function(){l().then(e=>{if(!e){const e=document.getElementById("profiles-list"),t=document.getElementById("profile-name"),n=document.getElementById("profile-save"),r=document.getElementById("profile-delete"),a=document.getElementById("profile-rename");e&&(e.disabled=!0),t&&(t.disabled=!0),[n,r,a].forEach(e=>{e&&(e.disabled=!0)});const l=document.querySelector(".profiles");if(l){const e=document.createElement("p");e.className="muted",e.textContent="Profile saving is disabled (storage not allowed).",l.appendChild(e)}return}const n=document.getElementById("profile-save"),r=document.getElementById("profile-delete"),a=document.getElementById("profile-rename"),l=document.getElementById("profiles-list"),o=document.getElementById("profile-name");if(n&&n.addEventListener("click",()=>f(o&&o.value&&o.value.trim())),r&&r.addEventListener("click",h),a&&a.addEventListener("click",g),l&&l.addEventListener("change",y),document.querySelectorAll("select[id]:not(#profiles-list):not(#language-selector)").forEach(e=>e.addEventListener("change",m)),document.querySelectorAll('input[id^="inventory-"]').forEach(e=>e.addEventListener("input",m)),window.addEventListener("beforeunload",m),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&m()}),u(),l){const e=c(),n=(()=>{try{return localStorage.getItem(t)}catch(e){return null}})(),r=()=>{y(),setTimeout(()=>{"undefined"!=typeof CalculatorModule&&CalculatorModule.calculateAll&&CalculatorModule.calculateAll(),"undefined"!=typeof ChiefGearCalculator&&ChiefGearCalculator.calculateAll&&ChiefGearCalculator.calculateAll(),"undefined"!=typeof FireCrystalsCalculator&&FireCrystalsCalculator.calculateAll&&FireCrystalsCalculator.calculateAll()},0)};window.FireCrystalsCalculator&&window.FireCrystalsCalculator.init&&document.addEventListener("fc-calculator-ready",r,{once:!0}),window.ChiefGearCalculator&&window.ChiefGearCalculator.init&&document.addEventListener("chief-gear-calculator-ready",r,{once:!0}),window.CalculatorModule&&window.CalculatorModule.init&&document.addEventListener("charms-calculator-ready",r,{once:!0}),setTimeout(()=>{n&&e[n]?(l.value=n,r()):l.options.length>0&&(l.selectedIndex=0,r())},300)}})},readProfiles:c,writeProfiles:i,captureCurrent:s,applyProfileObject:d,renderProfilesList:u,saveNewProfile:f,loadSelectedProfile:y,deleteSelectedProfile:h,renameSelectedProfile:g,autoSaveCurrentProfile:m}}();"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>ProfilesModule.init()):ProfilesModule.init();