// Fire Crystal Costs Data Loader// Prefers inline JS data; falls back to CSV when available.(function() {    'use strict';    const CSV_URL = 'assets/fire_crystals_costs.csv';    const loader = (window.WOSData && window.WOSData.loader) || null;    // Fallback calculator if modules are not loaded.    const fallbackCalc = {        buildCostIndex: (rows) => Array.isArray(rows) ? rows.map(r => ({            building: r.building,            level: r.level,            fc: Number(r.fc) || 0,            rfc: Number(r.rfc) || 0        })) : [],        sumRange: (costIndex, buildingName, fromLevel, toLevel, levelsArray) => {            if (!costIndex || !buildingName || !Array.isArray(levelsArray)) return null;            const fromIndex = levelsArray.indexOf(fromLevel);            const toIndex = levelsArray.indexOf(toLevel);            if (fromIndex === -1 || toIndex === -1 || fromIndex >= toIndex) return null;            const levelsToUpgrade = levelsArray.slice(fromIndex, toIndex + 1);            let totalFC = 0;            let totalRFC = 0;            levelsToUpgrade.forEach(lvl => {                const row = costIndex.find(r => r.building === buildingName && r.level === lvl);                if (!row) return;                totalFC += row.fc || 0;                totalRFC += row.rfc || 0;            });            return { normalFC: totalFC, refineFC: totalRFC };        }    };    const fcCalc = (window.WOSCalcs && window.WOSCalcs.fireCrystals) || fallbackCalc;    window.WOSCalcs = window.WOSCalcs || {};    if (!window.WOSCalcs.fireCrystals) {        window.WOSCalcs.fireCrystals = fcCalc;    }    let fireCrystalCostsCache = null;    let status = (loader && loader.makeStatus && loader.makeStatus('fc-data')) || { resource: 'fc-data', loaded: false, rows: 0, source: 'loading', error: false };    window.FCDataStatus = status;    function setStatus(partial) {        status = Object.assign({}, status, partial);        window.FCDataStatus = status;        if (loader && loader.dispatchReady) {            loader.dispatchReady('fc-data', status);        } else {            try { window.dispatchEvent(new CustomEvent('fc-data-ready', { detail: status })); } catch (_) {}        }    }    function normalizeInlineRows() {        if (!Array.isArray(window.FireCrystalFlatCosts)) return null;        return window.FireCrystalFlatCosts.map(r => ({            building: r.building,            level: r.level,            fc: Number(r.fc) || 0,            rfc: Number(r.rfc) || 0        }));    }    async function loadFromCsv() {        if (!loader || !loader.loadCsv) return null;        const csv = await loader.loadCsv(CSV_URL);        if (!csv || !csv.header || !csv.rows || csv.header.length === 0) return null;        const lower = csv.header.map(h => (h || '').toLowerCase());        const idx = {            building: lower.indexOf('building'),            level: lower.indexOf('level'),            fc: lower.indexOf('fc'),            rfc: lower.indexOf('rfc')        };        if (Object.values(idx).some(v => v === -1)) return null;        return csv.rows.map(row => ({            building: row[idx.building],            level: row[idx.level],            fc: Number(row[idx.fc]) || 0,            rfc: Number(row[idx.rfc]) || 0        }));    }    async function ensureCosts() {        if (fireCrystalCostsCache) return fireCrystalCostsCache;        const inlineRows = normalizeInlineRows();        if (inlineRows && inlineRows.length > 0) {            fireCrystalCostsCache = fcCalc && fcCalc.buildCostIndex ? fcCalc.buildCostIndex(inlineRows) : inlineRows;            setStatus({ loaded: true, rows: fireCrystalCostsCache.length, source: 'js', error: false });            return fireCrystalCostsCache;        }        const csvRows = await loadFromCsv();        if (csvRows && csvRows.length > 0) {            fireCrystalCostsCache = fcCalc && fcCalc.buildCostIndex ? fcCalc.buildCostIndex(csvRows) : csvRows;            setStatus({ loaded: true, rows: fireCrystalCostsCache.length, source: 'csv', error: false });            return fireCrystalCostsCache;        }        setStatus({ loaded: false, rows: 0, source: 'missing', error: true });        return null;    }    /**     * Get costs for a specific building between two levels using flat data     */    window.calculateFireCrystalCosts = async function(buildingName, fromLevel, toLevel, levelsArray) {        if (!fcCalc) {            console.error('FireCrystal calculator module not available');            return null;        }        const dataset = await ensureCosts();        if (!dataset) return null;        return fcCalc.sumRange(dataset, buildingName, fromLevel, toLevel, levelsArray);    };    })();