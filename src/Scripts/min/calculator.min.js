const allBatchInputs=Array.from(document.querySelectorAll('select[id$="-batch-from"], select[id$="-batch-to"]'));allBatchInputs.forEach(e=>{e.addEventListener("change",()=>{window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&ProfilesModule.autoSaveCurrentProfile()})});const CalculatorModule=function(){const e={1:{guides:5,designs:5,secrets:0,power:205700,svsPoints:43750},2:{guides:40,designs:15,secrets:0,power:288e3,svsPoints:87500},3:{guides:60,designs:40,secrets:0,power:37e4,svsPoints:218750},4:{guides:80,designs:100,secrets:0,power:452e3,svsPoints:612500},5:{guides:100,designs:200,secrets:0,power:576e3,svsPoints:787500},6:{guides:120,designs:300,secrets:0,power:7e5,svsPoints:875e3},7:{guides:140,designs:400,secrets:0,power:824e3,svsPoints:875e3},8:{guides:200,designs:400,secrets:0,power:948e3,svsPoints:91e4},9:{guides:300,designs:400,secrets:0,power:1072e3,svsPoints:98e4},10:{guides:420,designs:420,secrets:0,power:1196e3,svsPoints:105e4},11:{guides:560,designs:420,secrets:0,power:132e4,svsPoints:112e4},12:{guides:580,designs:450,secrets:15,power:1536e3,svsPoints:119e4},13:{guides:580,designs:450,secrets:30,power:1752e3,svsPoints:126e4},14:{guides:600,designs:500,secrets:45,power:1968e3,svsPoints:133e4},15:{guides:600,designs:500,secrets:70,power:2184e3,svsPoints:14e5},16:{guides:650,designs:550,secrets:100,power:24e5,svsPoints:147e4}},s=[-1];for(let e=1;e<=16;e++)s.push(e);const t=(-1).toString();function n(e){return-1===Number(e)}function r(e){return n(e)?window.I18n?.t("locked")||"Locked":e}function o(e,s){if(!e)return;const t=s.map(e=>{return s=String(e),String(s).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");var s});if(0===t.length)return e.removeAttribute("data-level-regex"),void e.setCustomValidity("");const n=`^(${t.join("|")})$`;e.setAttribute("data-level-regex",n);const r=new RegExp(n);e.value&&!r.test(e.value)?e.setCustomValidity("Invalid level selection"):e.setCustomValidity("")}function i(e){if(window.IconHelper)return window.IconHelper.label(e,e=>e.charAt(0).toUpperCase()+e.slice(1));const s={guides:"../src/assets/resources/charms/guides.png",designs:"../src/assets/resources/charms/designs.png",secrets:"../src/assets/resources/charms/secrets.png"}[e];if(!s)return e;const t=e.charAt(0).toUpperCase()+e.slice(1);return`<img class="res-icon" src="${s}" alt="${t}" onerror="this.style.display='none'"> ${t}`}function a(e){const s=window.I18n?.t||(e=>e),t=s(e)||e.charAt(0).toUpperCase()+e.slice(1),n=s("total")||"Total";if(window.IconHelper)return window.IconHelper.label(e,()=>`${n} ${t}`);const r={guides:"../src/assets/resources/charms/guides.png",designs:"../src/assets/resources/charms/designs.png",secrets:"../src/assets/resources/charms/secrets.png"}[e],o=`${n} ${t}`;return r?`<img class="res-icon" src="${r}" alt="${o}" onerror="this.style.display='none'"> ${o}`:o}function c(s,t){const n={guides:0,designs:0,secrets:0,power:0,svsPoints:0},r=Number(s),o=Number(t);if(isNaN(r)||isNaN(o)||o<=r)return n;for(let s=r+1;s<=o;s++){const t=e[s];t&&(n.guides+=t.guides||0,n.designs+=t.designs||0,n.secrets+=t.secrets||0,n.svsPoints+=t.svsPoints||0)}const i=e[o];return n.power=i&&"number"==typeof i.power?i.power:0,n}function d(e){return e.toLocaleString()}function l(){const e=Array.from(document.querySelectorAll('select[id$="-start"]')),s={guides:0,designs:0,secrets:0,power:0,svsPoints:0},t=[],o={};["hat","chestplate","ring","watch","pants","staff"].forEach(e=>{const s=Array.from(document.querySelectorAll(`select[id^="${e}-charm-"][id$="-start"]`));if(s.length>1){const t=s[0]?.value,r=document.getElementById(s[0]?.id.replace("-start","-finish"))?.value,i=s.every(e=>e.value===t),a=s.every(e=>{const s=e.id.replace("-start","-finish"),t=document.getElementById(s);return t&&t.value===r}),c=Number(t),d=Number(r),l=n(c)&&n(d);i&&a&&!l&&(o[e]=!0)}}),e.forEach(e=>{const n=e.id.slice(0,-6),r=document.getElementById(n+"-finish");if(!r)return;const o=Number(e.value),i=Number(r.value),a=c(o,i);(a.guides||a.designs||a.secrets||a.power||a.svsPoints)&&(t.push({id:n,from:o,to:i,sum:a}),s.guides+=a.guides,s.designs+=a.designs,s.secrets+=a.secrets,s.svsPoints+=a.svsPoints,s.power+=Number(a.power||0))});const l=document.getElementById("calculation-results");if(!l)return;l.innerHTML="";const u=parseInt(document.getElementById("inventory-guides")?.value||"0",10),g=parseInt(document.getElementById("inventory-designs")?.value||"0",10),m=parseInt(document.getElementById("inventory-secrets")?.value||"0",10),p=(s.guides,s.designs,s.secrets,s.guides>0||s.designs>0||s.secrets>0);function f(e,s,t){const n=s-t;if(!p)return`\n          <div class="total-line">\n            <p><strong>${e}:</strong> ${d(s)}</p>\n          </div>`;const r=window.I18n?.t||(e=>e),o=n>0?"deficit":"surplus",i=n>0?`⚠ ${r("need-more")} ${d(n)} ${r("more")}`:`✅ ${r("will-have")} ${d(Math.abs(n))} ${r("left")}`;return`\n        <div class="total-line">\n          <p><strong>${e}:</strong> ${d(s)}</p>\n          <div class="gap-line ${o}" aria-label="After inventory: ${i}">${i}</div>\n        </div>`}const h=`\n      <div class="result-totals" aria-live="polite">\n        ${f(a("guides"),s.guides,u)}\n        ${f(a("designs"),s.designs,g)}\n        ${f(a("secrets"),s.secrets,m)}\n        <div class="total-item summary-pill power-pill" style="background: var(--accent-secondary); color: white;">\n          <p><strong>${window.I18n?.t("total-power")||"Total Power"}:</strong> ${d(s.power)}</p>\n        </div>\n        <div class="total-item summary-pill svs-pill" style="background: var(--accent); color: white;">\n          <p><strong>${window.I18n?.t("total-svs-points")||"Total SvS Points"}:</strong> ${d(s.svsPoints)}</p>\n        </div>\n      </div>`;if(!t.length)return void(l.innerHTML=h);const v=window.I18n?.t||(e=>e);const $={};t.forEach(e=>{const s=e.id.split("-")[0];$[s]||($[s]={type:s,charms:[]}),$[s].charms.push(e)});const w=[];Object.values($).forEach(e=>{if(o[e.type]){const s={guides:0,designs:0,secrets:0,power:0,svsPoints:0,from:e.charms[0].from,to:e.charms[0].to};e.charms.forEach(e=>{s.guides+=e.sum.guides,s.designs+=e.sum.designs,s.secrets+=e.sum.secrets,s.power+=Number(e.sum.power||0),s.svsPoints+=Number(e.sum.svsPoints||0)});const t=v(`${e.type}-charms`)||e.type.charAt(0).toUpperCase()+e.type.slice(1)+" Charms";w.push(`\n          <tr>\n            <td>${t}</td>\n            <td>${r(s.from)}</td>\n            <td>${r(s.to)}</td>\n            <td><img class="res-icon" src="assets/resources/charms/guides.png" alt="Guides"> ${d(s.guides)}</td>\n            <td><img class="res-icon" src="assets/resources/charms/designs.png" alt="Designs"> ${d(s.designs)}</td>\n            <td><img class="res-icon" src="assets/resources/charms/secrets.png" alt="Secrets"> ${d(s.secrets)}</td>\n            <td>${d(s.power)}</td>\n            <td>${d(s.svsPoints)}</td>\n          </tr>`)}else e.charms.forEach(e=>{w.push(`\n            <tr>\n              <td>${function(e){const s=e.match(/^([a-z]+)-charm-(\d+)/i);if(s){const e=`${s[1]}-charms`,t=`charm-${s[2]}`;return`${v(e)||`${s[1].charAt(0).toUpperCase()+s[1].slice(1)} Charms`} - ${v(t)||`Charm ${s[2]}`}`}return e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}(e.id)}</td>\n              <td>${r(e.from)}</td>\n              <td>${r(e.to)}</td>\n              <td><img class="res-icon" src="assets/resources/charms/guides.png" alt="Guides"> ${d(e.sum.guides)}</td>\n              <td><img class="res-icon" src="assets/resources/charms/designs.png" alt="Designs"> ${d(e.sum.designs)}</td>\n              <td><img class="res-icon" src="assets/resources/charms/secrets.png" alt="Secrets"> ${d(e.sum.secrets)}</td>\n              <td>${d(e.sum.power||0)}</td>\n              <td>${d(e.sum.svsPoints||0)}</td>\n            </tr>`)})});const y=w.join("\n"),P=`\n      <div class="results-wrap table-responsive">\n        <table class="results-table" aria-live="polite">\n          <thead>\n            <tr>\n              <th data-key="slot">${v("slot")}</th>\n              <th data-key="from">${v("from")}</th>\n              <th data-key="to">${v("to")}</th>\n              <th data-key="guides">${i("guides")}</th>\n              <th data-key="designs">${i("designs")}</th>\n              <th data-key="secrets">${i("secrets")}</th>\n              <th data-key="power">${v("power")||"Power"}</th>\n              <th data-key="svsPoints">${v("svs-points")||"SvS Points"}</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${y}\n          </tbody>\n          <tfoot>\n            <tr>\n              <td>${v("totals")}</td>\n              <td>&nbsp;</td>\n              <td>&nbsp;</td>\n              <td><img class="res-icon" src="assets/resources/charms/guides.png" alt="Guides"> ${d(s.guides)}</td>\n              <td><img class="res-icon" src="assets/resources/charms/designs.png" alt="Designs"> ${d(s.designs)}</td>\n              <td><img class="res-icon" src="assets/resources/charms/secrets.png" alt="Secrets"> ${d(s.secrets)}</td>\n              <td>${d(s.power)}</td>\n              <td>${d(s.svsPoints)}</td>\n            </tr>\n          </tfoot>\n        </table>\n      </div>`;l.innerHTML=h+P,"undefined"!=typeof TableSortModule&&TableSortModule.makeTableSortable(document.querySelector(".results-table"))}function u(e,s,t){const n="from"===s?"-start":"-finish";Array.from(document.querySelectorAll(`select[id^="${e}-charm-"]`)).filter(e=>e.id.endsWith(n)).forEach(e=>{if(e.value=String(t),"to"===s){const s=e.id.replace(/-finish$/,""),n=document.getElementById(s+"-start");if(n){const s=parseInt(n.value),r=parseInt(t);!isNaN(s)&&!isNaN(r)&&s>r&&(n.value=String(t)),m(n,e)}}if("from"===s){const s=e.id.replace(/-start$/,""),n=document.getElementById(s+"-finish");if(n){const s=parseInt(t),r=parseInt(n.value);!isNaN(s)&&!isNaN(r)&&s>r&&(n.value=String(t)),m(e,n)}}}),l(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}function g(){Array.from(document.querySelectorAll('select[id$="-start"], select[id$="-finish"]')).filter(e=>!e.id.endsWith("-from")&&!e.id.endsWith("-to")).forEach(e=>{e.value=t});Array.from(document.querySelectorAll('select[id$="-from"], select[id$="-to"]')).forEach(e=>{e.value=t});Array.from(document.querySelectorAll('select[id$="-start"]')).filter(e=>!e.id.endsWith("-from")&&!e.id.endsWith("-to")).forEach(e=>{const s=e.id.replace(/-start$/,""),t=document.getElementById(s+"-finish");t&&m(e,t)});["hat","chestplate","ring","watch","pants","staff"].forEach(e=>{const s=document.getElementById(`${e}-batch-from`),t=document.getElementById(`${e}-batch-to`);s&&t&&m(s,t)}),l()}function m(e,t){if(!e||!t)return;const n=parseInt(e.value,10),r=parseInt(t.value,10);isNaN(n)||Array.from(t.options).forEach(e=>{const s=parseInt(e.value,10);!isNaN(s)&&s<n?e.disabled=!0:e.disabled=!1}),!isNaN(n)&&!isNaN(r)&&n>r&&(t.value=n.toString()),function(e,t){if(e){const n=parseInt(t?.value,10);o(e,Number.isNaN(n)?s:s.filter(e=>e<=n))}if(t){const n=parseInt(e?.value,10);o(t,Number.isNaN(n)?s:s.filter(e=>e>=n))}}(e,t)}return{init:async function(){await async function(s="assets/charms_unified.csv"){try{const t=await fetch(s,{cache:"no-cache"});if(!t.ok)return;const n=(await t.text()).split(/\r?\n/).filter(e=>e.trim().length>0);if(0===n.length)return;const r=n[0].split(",").map(e=>e.trim().toLowerCase()),o={level:r.indexOf("level"),guides:r.indexOf("guides"),designs:r.indexOf("designs"),secrets:r.indexOf("secrets"),power:r.indexOf("power"),svsPoints:r.indexOf("svspoints")};if(Object.values(o).some(e=>-1===e))return;let i=0;for(let s=1;s<n.length;s++){const t=n[s].split(",");if(t.length<r.length)continue;const a=parseInt(t[o.level],10);isNaN(a)||(e[a]={guides:parseInt(t[o.guides],10)||0,designs:parseInt(t[o.designs],10)||0,secrets:parseInt(t[o.secrets],10)||0,power:parseInt(t[o.power],10)||0,svsPoints:parseInt(t[o.svsPoints],10)||0},i++)}i>0&&console.info(`[Charms] Applied ${i} cost overrides from CSV.`)}catch(e){console.warn("[Charms] CSV override skipped:",e.message||e)}}(),Array.from(document.querySelectorAll('select[id$="-start"]')).filter(e=>!e.id.endsWith("-from")&&!e.id.endsWith("-to")).forEach(e=>{const s=e.id.replace(/-start$/,""),t=document.getElementById(s+"-finish");t&&(m(e,t),e.addEventListener("change",()=>{m(e,t),l(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}),t.addEventListener("change",()=>{m(e,t),l(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}))}),["hat","chestplate","ring","watch","pants","staff"].forEach(e=>{const s=document.getElementById(`${e}-batch-from`),t=document.getElementById(`${e}-batch-to`);s&&t&&(m(s,t),s.addEventListener("change",()=>{const n=t.value;m(s,t),u(e,"from",s.value),t.value!==n&&u(e,"to",t.value),l(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}),t.addEventListener("change",()=>{m(s,t),u(e,"to",t.value),l(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}))});const s=document.getElementById("charms-reset");s&&s.addEventListener("click",g);const t=document.getElementById("inventory-guides"),n=document.getElementById("inventory-designs"),r=document.getElementById("inventory-secrets");function o(e,s){e&&(e.addEventListener("input",()=>{let t=String(e.value||"");t=t.replace(/\D+/g,""),t.length>s&&(t=t.slice(0,s)),e.value!==t&&(e.value=t),l()}),e.addEventListener("change",()=>{l()}),e.addEventListener("keyup",()=>{l()}))}o(t,8),o(n,8),o(r,6),l()},calculateAll:l,sumCosts:c,applyBatch:u,resetCharms:g}}();"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>CalculatorModule.init()):CalculatorModule.init();