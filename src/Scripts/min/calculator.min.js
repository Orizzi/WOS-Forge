const allBatchInputs=Array.from(document.querySelectorAll('select[id$="-batch-from"], select[id$="-batch-to"]'));allBatchInputs.forEach(e=>{e.addEventListener("change",()=>{window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&ProfilesModule.autoSaveCurrentProfile()})});const CalculatorModule=function(){const e={0:{guides:5,designs:5,secrets:0,power:205700,svsPoints:625},1:{guides:40,designs:15,secrets:0,power:288e3,svsPoints:1250},2:{guides:60,designs:40,secrets:0,power:37e4,svsPoints:3125},3:{guides:80,designs:100,secrets:0,power:452e3,svsPoints:8750},4:{guides:100,designs:200,secrets:0,power:576e3,svsPoints:11250},5:{guides:120,designs:300,secrets:0,power:7e5,svsPoints:12500},6:{guides:140,designs:400,secrets:0,power:824e3,svsPoints:12500},7:{guides:200,designs:400,secrets:0,power:948e3,svsPoints:13e3},8:{guides:300,designs:400,secrets:0,power:1072e3,svsPoints:14e3},9:{guides:420,designs:420,secrets:0,power:1196e3,svsPoints:15e3},10:{guides:560,designs:420,secrets:0,power:132e4,svsPoints:16e3},11:{guides:580,designs:450,secrets:15,power:1536e3,svsPoints:17e3},12:{guides:580,designs:450,secrets:30,power:1752e3,svsPoints:18e3},13:{guides:600,designs:500,secrets:45,power:1968e3,svsPoints:19e3},14:{guides:600,designs:500,secrets:70,power:2184e3,svsPoints:2e4},15:{guides:650,designs:550,secrets:100,power:24e5,svsPoints:21e3}};function s(e){if(window.IconHelper)return window.IconHelper.label(e,e=>e.charAt(0).toUpperCase()+e.slice(1));const s={guides:"assets/resources/charms/guides.png",designs:"assets/resources/charms/designs.png",secrets:"assets/resources/charms/secrets.png"}[e];if(!s)return e;const t=e.charAt(0).toUpperCase()+e.slice(1);return`<img class="res-icon" src="${s}" alt="${t}" onerror="this.style.display='none'"> ${t}`}function t(e){const s=window.I18n?.t||(e=>e),t=s(e)||e.charAt(0).toUpperCase()+e.slice(1),r=s("total")||"Total";if(window.IconHelper)return window.IconHelper.label(e,()=>`${r} ${t}`);const n={guides:"assets/resources/charms/guides.png",designs:"assets/resources/charms/designs.png",secrets:"assets/resources/charms/secrets.png"}[e],o=`${r} ${t}`;return n?`<img class="res-icon" src="${n}" alt="${o}" onerror="this.style.display='none'"> ${o}`:o}function r(s,t){const r={guides:0,designs:0,secrets:0,power:0,svsPoints:0},n=Number(s),o=Number(t);if(isNaN(n)||isNaN(o)||o<=n)return r;for(let s=n+1;s<=o;s++){const t=e[s];t&&(r.guides+=t.guides||0,r.designs+=t.designs||0,r.secrets+=t.secrets||0,r.svsPoints+=t.svsPoints||0)}const i=e[o];return r.power=i&&"number"==typeof i.power?i.power:0,r}function n(e){return e.toLocaleString()}function o(){const e=Array.from(document.querySelectorAll('select[id$="-start"]')),o={guides:0,designs:0,secrets:0,power:0,svsPoints:0},i=[],a={};["hat","chestplate","ring","watch","pants","staff"].forEach(e=>{const s=Array.from(document.querySelectorAll(`select[id^="${e}-charm-"][id$="-start"]`));if(s.length>1){const t=s[0]?.value,r=document.getElementById(s[0]?.id.replace("-start","-finish"))?.value,n=s.every(e=>e.value===t),o=s.every(e=>{const s=e.id.replace("-start","-finish"),t=document.getElementById(s);return t&&t.value===r});n&&o&&("0"!==t||"0"!==r)&&(a[e]=!0)}}),e.forEach(e=>{const s=e.id.slice(0,-6),t=document.getElementById(s+"-finish");if(!t)return;const n=Number(e.value),a=Number(t.value),c=r(n,a);(c.guides||c.designs||c.secrets||c.power||c.svsPoints)&&(i.push({id:s,from:n,to:a,sum:c}),o.guides+=c.guides,o.designs+=c.designs,o.secrets+=c.secrets,o.svsPoints+=c.svsPoints,o.power+=Number(c.power||0))});const c=document.getElementById("calculation-results");if(!c)return;c.innerHTML="";const d=parseInt(document.getElementById("inventory-guides")?.value||"0",10),l=parseInt(document.getElementById("inventory-designs")?.value||"0",10),u=parseInt(document.getElementById("inventory-secrets")?.value||"0",10),g=(o.guides,o.designs,o.secrets,o.guides>0||o.designs>0||o.secrets>0);function m(e,s,t){const r=s-t;if(!g)return`\n          <div class="total-line">\n            <p><strong>${e}:</strong> ${n(s)}</p>\n          </div>`;const o=window.I18n?.t||(e=>e),i=r>0?"deficit":"surplus",a=r>0?`⚠ ${o("need-more")} ${n(r)} ${o("more")}`:`✅ ${o("will-have")} ${n(Math.abs(r))} ${o("left")}`;return`\n        <div class="total-line">\n          <p><strong>${e}:</strong> ${n(s)}</p>\n          <div class="gap-line ${i}" aria-label="After inventory: ${a}">${a}</div>\n        </div>`}const f=`\n      <div class="result-totals" aria-live="polite">\n        ${m(t("guides"),o.guides,d)}\n        ${m(t("designs"),o.designs,l)}\n        ${m(t("secrets"),o.secrets,u)}\n        <p class="summary-pill power-pill" style="background: var(--accent-secondary); color: white;"><strong>${window.I18n?.t("total-power")||"Total Power"}:</strong> ${n(o.power)}</p>\n        <p class="summary-pill svs-pill" style="background: var(--accent); color: white;"><strong>${window.I18n?.t("total-svs-points")||"Total SvS Points"}:</strong> ${n(o.svsPoints)}</p>\n      </div>`;if(!i.length)return void(c.innerHTML=f);const p=window.I18n?.t||(e=>e);const h={};i.forEach(e=>{const s=e.id.split("-")[0];h[s]||(h[s]={type:s,charms:[]}),h[s].charms.push(e)});const v=[];Object.values(h).forEach(e=>{if(a[e.type]){const s={guides:0,designs:0,secrets:0,from:e.charms[0].from,to:e.charms[0].to};e.charms.forEach(e=>{s.guides+=e.sum.guides,s.designs+=e.sum.designs,s.secrets+=e.sum.secrets});const t=p(`${e.type}-charms`)||e.type.charAt(0).toUpperCase()+e.type.slice(1)+" Charms";v.push(`\n          <tr>\n            <td>${t}</td>\n            <td>${s.from}</td>\n            <td>${s.to}</td>\n            <td><img class="res-icon" src="assets/resources/charms/guides.png" alt="Guides"> ${n(s.guides)}</td>\n            <td><img class="res-icon" src="assets/resources/charms/designs.png" alt="Designs"> ${n(s.designs)}</td>\n            <td><img class="res-icon" src="assets/resources/charms/secrets.png" alt="Secrets"> ${n(s.secrets)}</td>\n          </tr>`)}else e.charms.forEach(e=>{v.push(`\n            <tr>\n              <td>${function(e){const s=e.match(/^([a-z]+)-charm-(\d+)/i);if(s){const e=`${s[1]}-charms`,t=`charm-${s[2]}`;return`${p(e)||`${s[1].charAt(0).toUpperCase()+s[1].slice(1)} Charms`} - ${p(t)||`Charm ${s[2]}`}`}return e.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}(e.id)}</td>\n              <td>${e.from}</td>\n              <td>${e.to}</td>\n              <td><img class="res-icon" src="assets/resources/charms/guides.png" alt="Guides"> ${n(e.sum.guides)}</td>\n              <td><img class="res-icon" src="assets/resources/charms/designs.png" alt="Designs"> ${n(e.sum.designs)}</td>\n              <td><img class="res-icon" src="assets/resources/charms/secrets.png" alt="Secrets"> ${n(e.sum.secrets)}</td>\n            </tr>`)})});const $=v.join("\n"),y=`\n      <div class="results-wrap">\n        <table class="results-table" aria-live="polite">\n          <thead>\n            <tr>\n              <th data-key="slot">${p("slot")}</th>\n              <th data-key="from">${p("from")}</th>\n              <th data-key="to">${p("to")}</th>\n              <th data-key="guides">${s("guides")}</th>\n              <th data-key="designs">${s("designs")}</th>\n              <th data-key="secrets">${s("secrets")}</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${$}\n          </tbody>\n          <tfoot>\n            <tr>\n              <td colspan="3">${p("totals")}</td>\n              <td><img class="res-icon" src="assets/resources/charms/guides.png" alt="Guides"> ${n(o.guides)}</td>\n              <td><img class="res-icon" src="assets/resources/charms/designs.png" alt="Designs"> ${n(o.designs)}</td>\n              <td><img class="res-icon" src="assets/resources/charms/secrets.png" alt="Secrets"> ${n(o.secrets)}</td>\n            </tr>\n          </tfoot>\n        </table>\n      </div>`;c.innerHTML=f+y,"undefined"!=typeof TableSortModule&&TableSortModule.makeTableSortable(document.querySelector(".results-table"))}function i(e,s,t){const r="from"===s?"-start":"-finish";Array.from(document.querySelectorAll(`select[id^="${e}-charm-"]`)).filter(e=>e.id.endsWith(r)).forEach(e=>{if(e.value=String(t),"to"===s){const s=e.id.replace(/-finish$/,""),r=document.getElementById(s+"-start");if(r){const s=parseInt(r.value),n=parseInt(t);!isNaN(s)&&!isNaN(n)&&s>n&&(r.value=String(t)),c(r,e)}}if("from"===s){const s=e.id.replace(/-start$/,""),r=document.getElementById(s+"-finish");if(r){const s=parseInt(t),n=parseInt(r.value);!isNaN(s)&&!isNaN(n)&&s>n&&(r.value=String(t)),c(e,r)}}}),o(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}function a(){Array.from(document.querySelectorAll('select[id$="-start"], select[id$="-finish"]')).filter(e=>!e.id.endsWith("-from")&&!e.id.endsWith("-to")).forEach(e=>{e.value="0"});Array.from(document.querySelectorAll('select[id$="-from"], select[id$="-to"]')).forEach(e=>{e.value="0"});Array.from(document.querySelectorAll('select[id$="-start"]')).filter(e=>!e.id.endsWith("-from")&&!e.id.endsWith("-to")).forEach(e=>{const s=e.id.replace(/-start$/,""),t=document.getElementById(s+"-finish");t&&c(e,t)});["hat","chestplate","ring","watch","pants","staff"].forEach(e=>{const s=document.getElementById(`${e}-batch-from`),t=document.getElementById(`${e}-batch-to`);s&&t&&c(s,t)}),o()}function c(e,s){const t=parseInt(e.value),r=parseInt(s.value);isNaN(t)||Array.from(s.options).forEach(e=>{const s=parseInt(e.value);!isNaN(s)&&s<t?e.disabled=!0:e.disabled=!1}),!isNaN(t)&&!isNaN(r)&&t>r&&(s.value=t.toString())}return{init:async function(){await async function(s="assets/charms_costs.csv"){try{const t=await fetch(s,{cache:"no-cache"});if(!t.ok)return;const r=(await t.text()).split(/\r?\n/).filter(e=>e.trim().length>0);if(0===r.length)return;const n=r[0].split(",").map(e=>e.trim().toLowerCase()),o={level:n.indexOf("level"),guides:n.indexOf("guides"),designs:n.indexOf("designs"),secrets:n.indexOf("secrets"),power:n.indexOf("power"),svsPoints:n.indexOf("svspoints")};if(Object.values(o).some(e=>-1===e))return;let i=0;for(let s=1;s<r.length;s++){const t=r[s].split(",");if(t.length<n.length)continue;const a=parseInt(t[o.level],10);isNaN(a)||(e[a]={guides:parseInt(t[o.guides],10)||0,designs:parseInt(t[o.designs],10)||0,secrets:parseInt(t[o.secrets],10)||0,power:parseInt(t[o.power],10)||0,svsPoints:parseInt(t[o.svsPoints],10)||0},i++)}i>0&&console.info(`[Charms] Applied ${i} cost overrides from CSV.`)}catch(e){console.warn("[Charms] CSV override skipped:",e.message||e)}}(),Array.from(document.querySelectorAll('select[id$="-start"]')).filter(e=>!e.id.endsWith("-from")&&!e.id.endsWith("-to")).forEach(e=>{const s=e.id.replace(/-start$/,""),t=document.getElementById(s+"-finish");t&&(c(e,t),e.addEventListener("change",()=>{c(e,t),o(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}),t.addEventListener("change",()=>{c(e,t),o(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}))}),["hat","chestplate","ring","watch","pants","staff"].forEach(e=>{const s=document.getElementById(`${e}-batch-from`),t=document.getElementById(`${e}-batch-to`);s&&t&&(c(s,t),s.addEventListener("change",()=>{const r=t.value;c(s,t),i(e,"from",s.value),t.value!==r&&i(e,"to",t.value),o(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}),t.addEventListener("change",()=>{c(s,t),i(e,"to",t.value),o(),window.ProfilesModule&&ProfilesModule.autoSaveCurrentProfile&&setTimeout(()=>{ProfilesModule.autoSaveCurrentProfile()},0)}))});const s=document.getElementById("charms-reset");s&&s.addEventListener("click",a);const t=document.getElementById("inventory-guides"),r=document.getElementById("inventory-designs"),n=document.getElementById("inventory-secrets");function d(e,s){e&&(e.addEventListener("input",()=>{let t=String(e.value||"");t=t.replace(/\D+/g,""),t.length>s&&(t=t.slice(0,s)),e.value!==t&&(e.value=t),o()}),e.addEventListener("change",()=>{o()}),e.addEventListener("keyup",()=>{o()}))}d(t,8),d(r,8),d(n,6),o()},calculateAll:o,sumCosts:r,applyBatch:i,resetCharms:a}}();"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>CalculatorModule.init()):CalculatorModule.init();