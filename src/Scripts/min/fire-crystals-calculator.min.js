!function(){"use strict";async function e(){const e=["Scripts/modules/helpers/number-format.js","Scripts/modules/helpers/icons.js","Scripts/modules/helpers/csv.js","Scripts/modules/data/data-loader.js","Scripts/modules/calculators/fire-crystals.js","Scripts/modules/ui/fire-crystals-ui.js"].map(e=>function(e){return new Promise(t=>{if("undefined"==typeof document)return t();if(document.querySelector(`script[data-wos="${e}"]`))return void t();const n=document.createElement("script");n.src=e,n.dataset.wos=e,n.onload=()=>t(),n.onerror=()=>t(),document.head.appendChild(n)})}(e));await Promise.all(e)}function t(e,t){const n=1-function(e){return{0:0,1:.03,2:.06,3:.09,4:.12,5:.15}[Math.max(0,Math.min(5,parseInt(e,10)||0))]||0}(t),a=e=>Math.round((e||0)*n);return{...e,meat:a(e.meat),wood:a(e.wood),coal:a(e.coal),iron:a(e.iron)}}function n(e,t={}){const n=Number(e)||0,a=window.WOSHelpers&&window.WOSHelpers.number,o=Object.assign({maximumFractionDigits:0},t);if(a&&"function"==typeof a.formatNumber)try{return a.formatNumber(n,o,"en-US")}catch(e){}try{return n.toLocaleString("en-US",o)}catch(e){return String(n)}}function a(e){const t=window.WOSHelpers&&window.WOSHelpers.number;if(t&&"function"==typeof t.formatCompact)return t.formatCompact(Number(e)||0);if(null==e)return"0";const a=e<0?"-":"",o=Math.abs(Number(e))||0,s=e=>e.replace(/\.0+$/,"").replace(/(\.[0-9]*?)0+$/,"$1");return o>=1e9?a+s((o/1e9).toFixed(3))+"B":o>=1e6?a+s((o/1e6).toFixed(3))+"M":o>=1e3?a+s((o/1e3).toFixed(3))+"K":n("-"===a?-Math.floor(o):Math.floor(o))}const o=["F30","30-1","30-2","30-3","30-4","FC1","FC1-1","FC1-2","FC1-3","FC1-4","FC2","FC2-1","FC2-2","FC2-3","FC2-4","FC3","FC3-1","FC3-2","FC3-3","FC3-4","FC4","FC4-1","FC4-2","FC4-3","FC4-4","FC5","FC5-1","FC5-2","FC5-3","FC5-4","FC6","FC6-1","FC6-2","FC6-3","FC6-4","FC7","FC7-1","FC7-2","FC7-3","FC7-4","FC8","FC8-1","FC8-2","FC8-3","FC8-4","FC9","FC9-1","FC9-2","FC9-3","FC9-4","FC10"],s=["F30","30-1","30-2","30-3","30-4","FC1","FC1-1","FC1-2","FC1-3","FC1-4","FC2","FC2-1","FC2-2","FC2-3","FC2-4","FC3","FC3-1","FC3-2","FC3-3","FC3-4","FC4","FC4-1","FC4-2","FC4-3","FC4-4","FC5","FC5-1","FC5-2","FC5-3","FC5-4","FC6","FC6-1","FC6-2","FC6-3","FC6-4","FC7","FC7-1","FC7-2","FC7-3","FC7-4","FC8","FC8-1","FC8-2","FC8-3","FC8-4","FC9","FC9-1","FC9-2","FC9-3","FC9-4","FC10"],r=["FC1","FC1-1","FC1-2","FC1-3","FC1-4","FC2","FC2-1","FC2-2","FC2-3","FC2-4","FC3","FC3-1","FC3-2","FC3-3","FC3-4","FC4","FC4-1","FC4-2","FC4-3","FC4-4","FC5","FC5-1","FC5-2","FC5-3","FC5-4","FC6","FC6-1","FC6-2","FC6-3","FC6-4","FC7","FC7-1","FC7-2","FC7-3","FC7-4","FC8","FC8-1","FC8-2","FC8-3","FC8-4","FC9","FC9-1","FC9-2","FC9-3","FC9-4","FC10"],l=["Furnace","Embassy","Command Center","Infirmary","Infantry Camp","Marksman Camp","Lancer Camp","War Academy"];let i=null;async function c(){if(i)return i;const e=window.WOSData&&window.WOSData.loader;if(!e||!e.loadCsv)return null;const t=await e.loadCsv("assets/fire_crystals_unified.csv");if(!t||!t.header||!t.rows||0===t.header.length)return null;const n=t.header.map(e=>(e||"").toLowerCase()),a={building:n.indexOf("building"),level:n.indexOf("level"),fc:n.indexOf("fc"),rfc:n.indexOf("rfc"),timeSeconds:n.indexOf("timeseconds"),meat:n.indexOf("meat"),wood:n.indexOf("wood"),coal:n.indexOf("coal"),iron:n.indexOf("iron"),power:n.indexOf("power")};if(Object.values(a).some(e=>-1===e))return console.warn("[FireCrystals] Unified CSV missing required columns"),null;const o={};return t.rows.forEach(e=>{const t=e[a.building],n=e[a.level];if(!t||!n)return;const s={fc:Number(e[a.fc])||0,rfc:Number(e[a.rfc])||0,timeSeconds:Number(e[a.timeSeconds])||0,meat:Number(e[a.meat])||0,wood:Number(e[a.wood])||0,coal:Number(e[a.coal])||0,iron:Number(e[a.iron])||0,power:Number(e[a.power])||0};o[t]||(o[t]={}),o[t][n]=s}),i={byBuilding:o},i}function d(e,t,n){const a=e.value,o=t.value;if(!a||!o)return;const s=n.indexOf(a),r=n.indexOf(o);-1!==s&&(Array.from(t.options).forEach(e=>{const t=n.indexOf(e.value);e.disabled=-1!==t&&t<s}),-1!==r&&r<s&&(t.value=a))}function u(e){return"Furnace"===e?o:"War Academy"===e?r:s}async function m(e,t,n){if(!t||!n)return null;const a=u(e),o=a.indexOf(t),s=a.indexOf(n);if(-1===o||-1===s||o>=s)return console.warn("[FireCrystals] Invalid level range",{buildingName:e,fromLevel:t,toLevel:n}),null;const r=await async function(e,t,n){const a=await c();if(!a||!a.byBuilding||!a.byBuilding[e])return null;const o=u(e);if(!o||0===o.length)return null;let s=o.indexOf(t);const r=o.indexOf(n),l="F30"===t||t&&t.startsWith("30-");if(-1===s&&l&&(s=-1),-1===s||-1===r||r<=s)return{totalFc:0,totalRfc:0,totalTimeSeconds:0,totalMeat:0,totalWood:0,totalCoal:0,totalIron:0};const i={totalFc:0,totalRfc:0,totalTimeSeconds:0,totalMeat:0,totalWood:0,totalCoal:0,totalIron:0},d=a.byBuilding[e]||{};for(let e=s+1;e<=r;e++){const t=d[o[e]];t&&(i.totalFc+=t.fc||0,i.totalRfc+=t.rfc||0,i.totalTimeSeconds+=t.timeSeconds||0,i.totalMeat+=t.meat||0,i.totalWood+=t.wood||0,i.totalCoal+=t.coal||0,i.totalIron+=t.iron||0)}return i}(e,t,n);return r?{normalFC:r.totalFc,refineFC:r.totalRfc,time:r.totalTimeSeconds,meat:r.totalMeat,wood:r.totalWood,coal:r.totalCoal,iron:r.totalIron}:null}function p(e){return{days:Math.floor(e/86400),hours:Math.floor(e%86400/3600),minutes:Math.floor(e%3600/60)}}async function C(){const e=await c();if(!e||!e.byBuilding)return void console.warn("[FireCrystals] Unified data not available");const o={};let s=0,r=0,i=0,d=0,u=0,C=0,F=0;const f=parseInt(document.getElementById("zinman-level")?.value||0,10)||0;for(const e of l){const n=e.toLowerCase().replace(/ /g,"-"),a=document.getElementById(`${n}-start`),l=document.getElementById(`${n}-finish`);if(!a||!l)continue;const c=a.value,p=l.value;let y=await m(e,c,p);if(y){const n=t(y,f);o[e]={...n,from:c,to:p},s+=n.normalFC,r+=n.refineFC,i+=n.time,d+=n.meat||0,u+=n.wood||0,C+=n.coal||0,F+=n.iron||0}}const y=parseInt(document.getElementById("inventory-fire-crystals")?.value||0),v=parseInt(document.getElementById("inventory-refine-crystals")?.value||0),h=parseInt(document.getElementById("inventory-speedup-days")?.value||0),$=parseInt(document.getElementById("inventory-construction-speed")?.value||0),b=parseInt(document.getElementById("inventory-meat")?.value||0),g=parseInt(document.getElementById("inventory-wood")?.value||0),w=parseInt(document.getElementById("inventory-coal")?.value||0),I=parseInt(document.getElementById("inventory-iron")?.value||0);!function(e,t){const o=document.getElementById("results-display");if(!o)return;const s=window.I18n?window.I18n.getCurrentLanguage():"en",r=window.I18n?window.I18n.t:e=>e;function l(e,t){const n=window.WOSHelpers&&window.WOSHelpers.icons;if(n&&"function"==typeof n.label)return n.label(e,t?()=>t:e=>r(e));if(window.IconHelper&&"function"==typeof window.IconHelper.label){if(t){const n=()=>t;return window.IconHelper.label(e,n)}return window.IconHelper.label(e,r)}const a={"fire-crystals":"assets/resources/base/fire-crystals.png","refine-crystals":"assets/resources/base/refine-crystals.png",meat:"assets/resources/base/meat.png",wood:"assets/resources/base/wood.png",coal:"assets/resources/base/coal.png",iron:"assets/resources/base/iron.png"}[e],o=t||r(e);return a?`<img class="res-icon" src="${a}" alt="${o}" onerror="this.style.display='none'"> ${o}`:o}let i="";const c=(e.totalTime||0)>0||(e.totalNormalFC||0)>0||(e.totalRefineFC||0)>0||(e.totalMeat||0)>0||(e.totalWood||0)>0||(e.totalCoal||0)>0||(e.totalIron||0)>0,d=(e.totalMeat||0)-(e.inventoryMeat||0),u=d>0?"deficit":"surplus",m=d>0?r("gap-need-more",s).replace("%d",n(Math.abs(d))):r("gap-have-left",s).replace("%d",n(Math.abs(d)));i+=`<div class="total-item">\n            <span class="resource-label">${l("meat")}:</span>\n            <span class="resource-value">${n(e.totalMeat||0)}</span>\n            ${c?`<span class="gap ${u}">${m}</span>`:""}\n        </div>`;const C=(e.totalWood||0)-(e.inventoryWood||0),F=C>0?"deficit":"surplus",f=C>0?r("gap-need-more",s).replace("%d",n(Math.abs(C))):r("gap-have-left",s).replace("%d",n(Math.abs(C)));i+=`<div class="total-item">\n            <span class="resource-label">${l("wood")}:</span>\n            <span class="resource-value">${n(e.totalWood||0)}</span>\n            ${c?`<span class="gap ${F}">${f}</span>`:""}\n        </div>`;const y=(e.totalCoal||0)-(e.inventoryCoal||0),v=y>0?"deficit":"surplus",h=y>0?r("gap-need-more",s).replace("%d",n(Math.abs(y))):r("gap-have-left",s).replace("%d",n(Math.abs(y)));i+=`<div class="total-item">\n            <span class="resource-label">${l("coal")}:</span>\n            <span class="resource-value">${n(e.totalCoal||0)}</span>\n            ${c?`<span class="gap ${v}">${h}</span>`:""}\n        </div>`;const $=(e.totalIron||0)-(e.inventoryIron||0),b=$>0?"deficit":"surplus",g=$>0?r("gap-need-more",s).replace("%d",n(Math.abs($))):r("gap-have-left",s).replace("%d",n(Math.abs($)));i+=`<div class="total-item">\n            <span class="resource-label">${l("iron")}:</span>\n            <span class="resource-value">${n(e.totalIron||0)}</span>\n            ${c?`<span class="gap ${b}">${g}</span>`:""}\n        </div>`;const w=e.totalNormalFC-e.inventoryFC,I=w>0?"deficit":"surplus",S=w>0?r("gap-need-more",s).replace("%d",n(Math.abs(w))):r("gap-have-left",s).replace("%d",n(Math.abs(w)));i+=`<div class="total-item">\n            <span class="resource-label">${l("fire-crystals")}:</span>\n            <span class="resource-value">${n(e.totalNormalFC)}</span>\n            ${c?`<span class="gap ${I}">${S}</span>`:""}\n        </div>`;const M=e.totalRefineFC-e.inventoryRFC,O=M>0?"deficit":"surplus",E=M>0?r("gap-need-more",s).replace("%d",n(Math.abs(M))):r("gap-have-left",s).replace("%d",n(Math.abs(M)));i+=`<div class="total-item">\n            <span class="resource-label">${l("refine-crystals")}:</span>\n            <span class="resource-value">${n(e.totalRefineFC)}</span>\n            ${c?`<span class="gap ${O}">${E}</span>`:""}\n        </div>`;const N=p(e.totalTime);if(i+=`<div class="total-item">\n            <span class="resource-label">${r("total-time",s)}:</span>\n            <span class="resource-value">${N.days}d ${N.hours}h ${N.minutes}m</span>\n        </div>`,e.constructionSpeed>0){const t=p(e.adjustedTime);i+=`<div class="total-item">\n                <span class="resource-label">${r("total-reduced-time",s)}:</span>\n                <span class="resource-value">${t.days}d ${t.hours}h ${t.minutes}m</span>\n            </div>`}const W=e.adjustedTime-e.inventorySpeedupSeconds,B=p(Math.abs(W)),L=W>0?"deficit":"surplus",x=W>0?r("gap-time-need-more",s).replace("%dd %dh %dm",`${B.days}d ${B.hours}h ${B.minutes}m`):r("gap-time-have-left",s).replace("%dd %dh %dm",`${B.days}d ${B.hours}h ${B.minutes}m`);i+=`<div class="total-item">\n            <span class="resource-label">${r("speedup-days",s)}:</span>\n            <span class="resource-value">${(e.adjustedTime/86400).toFixed(1)} days</span>\n            ${c?`<span class="gap ${L}">${x}</span>`:""}\n        </div>`;const T=2e3*e.totalNormalFC,j=3e4*e.totalRefineFC,k=e.adjustedTime/60*30,H=T+j+k;if(i+=`<div class="total-item">\n            <span class="resource-label">${r("svs-points-fc",s)}:</span>\n            <span class="resource-value">${n(Math.floor(T))}</span>\n        </div>`,i+=`<div class="total-item">\n            <span class="resource-label">${r("svs-points-rfc",s)}:</span>\n            <span class="resource-value">${n(Math.floor(j))}</span>\n        </div>`,i+=`<div class="total-item">\n            <span class="resource-label">${r("svs-points-speedup",s)}:</span>\n            <span class="resource-value">${n(Math.floor(k))}</span>\n        </div>`,i+=`<div class="total-item">\n            <span class="resource-label"><strong>${r("total-svs-points",s)}:</strong></span>\n            <span class="resource-value"><strong>${n(Math.floor(H))}</strong></span>\n        </div>`,Object.keys(t).length>0){const n=Object.entries(t).map(([e,t])=>{const n=p(t.time||0);return`<tr>\n                                        <td>${r(e,s)}</td>\n                                        <td>${t.from||""}</td>\n                                        <td>${t.to||""}</td>\n                                    <td>${a(Number(t.normalFC||0))}</td>\n                                    <td>${a(Number(t.refineFC||0))}</td>\n                                    <td>${a(Number(t.meat||0))}</td>\n                                    <td>${a(Number(t.wood||0))}</td>\n                                    <td>${a(Number(t.coal||0))}</td>\n                                    <td>${a(Number(t.iron||0))}</td>\n                                        <td>${n.days}d ${n.hours}h ${n.minutes}m</td>\n                                </tr>`}).join(""),o=p(e.totalTime||0),c=r("building",s)||"Building",d=c.charAt(0).toUpperCase()+c.slice(1);i+=`\n                        <div class="results-wrap">\n                            <h3>${r("building-breakdown",s)}</h3>\n                            <table class="results-table" aria-live="polite">\n                                <thead>\n                                    <tr>\n                                        <th data-key="slot">${d}</th>\n                                        <th data-key="from">${r("from",s)}</th>\n                                        <th data-key="to">${r("to",s)}</th>\n                                        <th data-key="fc">${l("fire-crystals","FC")}</th>\n                                        <th data-key="rfc">${l("refine-crystals","RFC")}</th>\n                                        <th data-key="meat">${l("meat")}</th>\n                                        <th data-key="wood">${l("wood")}</th>\n                                        <th data-key="coal">${l("coal")}</th>\n                                        <th data-key="iron">${l("iron")}</th>\n                                        <th data-key="time">${r("total-time",s)}</th>\n                                    </tr>\n                                </thead>\n                                <tbody>\n                                    ${n}\n                                </tbody>\n                                <tfoot>\n                                    <tr>\n                                        <td>${r("totals",s)}</td>\n                                        <td>&nbsp;</td>\n                                        <td>&nbsp;</td>\n                                        <td>${a(Number(e.totalNormalFC||0))}</td>\n                                        <td>${a(Number(e.totalRefineFC||0))}</td>\n                                        <td>${a(Number(e.totalMeat||0))}</td>\n                                        <td>${a(Number(e.totalWood||0))}</td>\n                                        <td>${a(Number(e.totalCoal||0))}</td>\n                                        <td>${a(Number(e.totalIron||0))}</td>\n                                        <td>${o.days}d ${o.hours}h ${o.minutes}m</td>\n                                    </tr>\n                                </tfoot>\n                            </table>\n                        </div>`}o.innerHTML=i;try{const e=o.querySelector(".results-table");e&&"undefined"!=typeof TableSortModule&&TableSortModule.makeTableSortable(e)}catch(e){}}({totalNormalFC:s,totalRefineFC:r,totalTime:i,adjustedTime:i*(100/(100+$)),inventoryFC:y,inventoryRFC:v,inventorySpeedupSeconds:86400*h,constructionSpeed:$,totalMeat:d,totalWood:u,totalCoal:C,totalIron:F,inventoryMeat:b,inventoryWood:g,inventoryCoal:w,inventoryIron:I},o)}async function F(){l.forEach(e=>{const t=e.toLowerCase().replace(/ /g,"-"),n=document.getElementById(`${t}-start`),a=document.getElementById(`${t}-finish`);if(n&&a){const t=u(e);n.options.length&&a.options.length||function(e){const t=e.toLowerCase().replace(/ /g,"-"),n=document.getElementById(`${t}-start`),a=document.getElementById(`${t}-finish`);if(!n||!a)return;const o=u(e),s=(e,t)=>{let n="";return o.forEach(a=>{const s=e?e===a:t?"FC10"===a:a===o[0];n+=`<option value="${a}"${s?" selected":""}>${a}</option>`}),n},r=n.value,l=a.value;n.innerHTML=s(r,!1),a.innerHTML=s(l,!0),d(n,a,o)}(e),n.addEventListener("change",()=>{d(n,a,t),C()}),a.addEventListener("change",()=>{d(n,a,t),C()})}});["inventory-fire-crystals","inventory-refine-crystals","inventory-speedup-days","inventory-construction-speed","inventory-meat","inventory-wood","inventory-coal","inventory-iron","zinman-level"].forEach(e=>{const t=document.getElementById(e);if(t){const n="zinman-level"===e?"change":"input";t.addEventListener(n,C)}}),document.addEventListener("change",e=>{const t=e.target;if(t&&t.classList&&t.classList.contains("building-select"))try{C()}catch(e){}});document.querySelectorAll('select[id$="-start"], select[id$="-finish"]').forEach(e=>{e.addEventListener("change",()=>{try{C()}catch(e){}})});try{window.addEventListener("fc-data-ready",()=>{try{C()}catch(e){}})}catch(e){}setTimeout(()=>{try{C()}catch(e){}},0)}async function f(){await e();const t=window.WOS&&window.WOS.ui&&window.WOS.ui.fireCrystals;return t&&"function"==typeof t.initPage?t.initPage({legacyInit:F}):F()}window.FireCrystalsCalculator={calculateAll:C,validateLevels:d,getLevelsForBuilding:u,init:f,legacyInit:F},window.WOSCalcCore&&"function"==typeof window.WOSCalcCore.registerAdapter&&window.WOSCalcCore.registerAdapter({id:"fireCrystals",isActive:()=>!!document.getElementById("furnace-start"),run:()=>C()}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f):f()}();